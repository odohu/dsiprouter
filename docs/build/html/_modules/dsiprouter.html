

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dsiprouter &mdash; dSIPRouter 0.64 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> dSIPRouter
          

          
          </a>

          
            
            
              <div class="version">
                0.64
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1.  User Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/installing.html">1.2.1. Installing dSIPRouter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/command_line_options.html">1.3.1. Command Line Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/configuring.html">1.4.1. Configuring dSIPRouter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/carrier_groups.html">1.4.1.1. Carrier Groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/carrier_groups.html#adding-a-carrier">1.4.1.2. Adding a Carrier</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/pbxs_and_endpoints.html">1.4.1.3. PBX(s) and Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/pbxs_and_endpoints.html#inbound-did-mapping">1.4.1.4. Inbound DID Mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/domains.html">1.4.1.5. Adding a Domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/global_outbound_routes.html">1.4.1.6. Global Outbound Routes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../user/api.html">1.5.1. API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/use-cases.html">1.6.1. Use Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/resources.html">1.7.1. Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/supported_configurations.html">1.8.1. Supported Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/troubleshooting.html">1.9.1. Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/upgrade.html">1.10.1. Upgrading dSIPRouter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user/upgrade_0.522_to_0.523.html">1.10.1.1.1. Upgrade dSIPRouter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/upgrade_0.50_to_0.51.html">1.10.1.2.1. Upgrade dSIPRouter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user/upgrade_0.621_to_0.63.html">1.10.1.3.1. Upgrade dSIPRouter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">2.  Developer Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dev/database.html">2.1.  database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/dsiprouter.html">2.2.  dsiprouter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/globals.html">2.3.  globals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/modules.html">2.4.  modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/settings.html">2.5.  settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/shared.html">2.6.  shared</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/sysloginit.html">2.7.  sysloginit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev/util.html">2.8.  util</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../routes/index.html">3.  Routes Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../routes/routes.html">3.1.  routes</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dSIPRouter</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>dsiprouter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dsiprouter</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">urllib.parse</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">csv</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">bjoern</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Server</span>
<span class="kn">from</span> <span class="nn">flask_wtf.csrf</span> <span class="kn">import</span> <span class="n">CSRFProtect</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">URLSafeTimedSerializer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">sql_exceptions</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">load_only</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">http_exceptions</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">from</span> <span class="nn">werkzeug.middleware.proxy_fix</span> <span class="kn">import</span> <span class="n">ProxyFix</span>
<span class="kn">from</span> <span class="nn">sysloginit</span> <span class="kn">import</span> <span class="n">initSyslogLogger</span>
<span class="kn">from</span> <span class="nn">shared</span> <span class="kn">import</span> <span class="n">getInternalIP</span><span class="p">,</span> <span class="n">getExternalIP</span><span class="p">,</span> <span class="n">updateConfig</span><span class="p">,</span> <span class="n">getCustomRoutes</span><span class="p">,</span> <span class="n">debugException</span><span class="p">,</span> <span class="n">debugEndpoint</span><span class="p">,</span> \
    <span class="n">stripDictVals</span><span class="p">,</span> <span class="n">strFieldsToDict</span><span class="p">,</span> <span class="n">dictToStrFields</span><span class="p">,</span> <span class="n">allowed_file</span><span class="p">,</span> <span class="n">showError</span><span class="p">,</span> <span class="n">hostToIP</span><span class="p">,</span> <span class="n">IO</span><span class="p">,</span> <span class="n">objToDict</span><span class="p">,</span> <span class="n">StatusCodes</span><span class="p">,</span> \
    <span class="n">safeUriToHost</span><span class="p">,</span> <span class="n">safeFormatSipUri</span><span class="p">,</span> <span class="n">safeStripPort</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db_engine</span><span class="p">,</span> <span class="n">SessionLoader</span><span class="p">,</span> <span class="n">DummySession</span><span class="p">,</span> <span class="n">Gateways</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">InboundMapping</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="p">,</span> <span class="n">Subscribers</span><span class="p">,</span> \
    <span class="n">dSIPLCR</span><span class="p">,</span> <span class="n">UAC</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="p">,</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">DomainAttrs</span><span class="p">,</span> <span class="n">dSIPDomainMapping</span><span class="p">,</span> <span class="n">dSIPMultiDomainMapping</span><span class="p">,</span> <span class="n">Dispatcher</span><span class="p">,</span> <span class="n">dSIPMaintModes</span><span class="p">,</span> \
    <span class="n">dSIPCallLimits</span><span class="p">,</span> <span class="n">dSIPHardFwd</span><span class="p">,</span> <span class="n">dSIPFailFwd</span>
<span class="kn">from</span> <span class="nn">modules</span> <span class="kn">import</span> <span class="n">flowroute</span>
<span class="kn">from</span> <span class="nn">modules.domain.domain_routes</span> <span class="kn">import</span> <span class="n">domains</span>
<span class="kn">from</span> <span class="nn">modules.api.api_routes</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">util.security</span> <span class="kn">import</span> <span class="n">Credentials</span><span class="p">,</span> <span class="n">AES_CTR</span><span class="p">,</span> <span class="n">urandomChars</span>
<span class="kn">from</span> <span class="nn">util.ipc</span> <span class="kn">import</span> <span class="n">createSettingsManager</span>
<span class="kn">from</span> <span class="nn">util.parse_json</span> <span class="kn">import</span> <span class="n">CreateEncoder</span>
<span class="kn">import</span> <span class="nn">globals</span>
<span class="kn">import</span> <span class="nn">settings</span>


<span class="c1"># module variables</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="s2">&quot;./static&quot;</span><span class="p">,</span> <span class="n">static_url_path</span><span class="o">=</span><span class="s2">&quot;/static&quot;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;docs&#39;</span><span class="p">,</span> <span class="s1">&#39;docs&#39;</span><span class="p">,</span> <span class="n">static_url_path</span><span class="o">=</span><span class="s1">&#39;/docs&#39;</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_DOCS_DIR</span><span class="p">))</span>
<span class="n">csrf</span> <span class="o">=</span> <span class="n">CSRFProtect</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">csrf</span><span class="o">.</span><span class="n">exempt</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
<span class="n">numbers_api</span> <span class="o">=</span> <span class="n">flowroute</span><span class="o">.</span><span class="n">Numbers</span><span class="p">()</span>
<span class="n">shared_settings</span> <span class="o">=</span> <span class="n">objToDict</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
<span class="n">settings_manager</span> <span class="o">=</span> <span class="n">createSettingsManager</span><span class="p">(</span><span class="n">shared_settings</span><span class="p">)</span>
<span class="c1"># TODO: unit testing per component</span>
<span class="c1"># TODO: many of these routes could use some updating...</span>
<span class="c1">#       possibly look into this as well when reworking the architecture for API</span>

<div class="viewcode-block" id="before_first_request"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.before_first_request">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">before_first_request</span>
<span class="k">def</span> <span class="nf">before_first_request</span><span class="p">():</span>
    <span class="c1"># replace werkzeug and sqlalchemy loggers</span>
    <span class="n">log_handler</span> <span class="o">=</span> <span class="n">initSyslogLogger</span><span class="p">()</span>
    <span class="n">replaceAppLoggers</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span></div>

<div class="viewcode-block" id="before_request"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.before_request">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="c1"># set the session lifetime to gui inactive timeout</span>
    <span class="c1"># if we are in debug mode force it to last for entire day</span>
    <span class="n">session</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">permanent_session_lifetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">permanent_session_lifetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">GUI_INACTIVE_TIMEOUT</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="api_before_request"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.api_before_request">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span> <span class="nf">api_before_request</span><span class="p">():</span>
    <span class="c1"># for ua to api w/ api token disable csrf</span>
    <span class="c1"># we only want csrf checks on service to service requests</span>
    <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">csrf</span><span class="o">.</span><span class="n">protect</span><span class="p">()</span></div>

<div class="viewcode-block" id="index"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.index">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;dashboard.html&#39;</span><span class="p">,</span> <span class="n">show_add_onload</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="displayError"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayError">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/error&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayError</span><span class="p">():</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_INTERNAL_SERVER_ERROR</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;msg&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="backupandrestore"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.backupandrestore">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/backupandrestore&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">backupandrestore</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;backupandrestore.html&#39;</span><span class="p">,</span> <span class="n">show_add_onload</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">log_ex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_ex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showstack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">log_ex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_ex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showstack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="certificates"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.certificates">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/certificates&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">certificates</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;certificates.html&#39;</span><span class="p">,</span> <span class="n">show_add_onload</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">log_ex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_ex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showstack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">log_ex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_ex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showstack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="favicon"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.favicon">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/favicon.ico&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">favicon</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">),</span>
        <span class="s1">&#39;favicon.ico&#39;</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/vnd.microsoft.icon&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="login"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.login">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="c1"># redirect GET requests to index</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">if</span> <span class="s1">&#39;username&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">or</span> <span class="s1">&#39;password&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Username and Password are required&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Username or Password is malformed&#39;</span><span class="p">)</span>

        <span class="c1"># Get Environment Variables if in debug mode</span>
        <span class="c1"># This is the only case we allow plain text password comparison</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_USERNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DSIP_USERNAME&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_USERNAME</span><span class="p">)</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DSIP_PASSWORD&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">)</span>

        <span class="c1"># if username valid, hash password and compare with stored password</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_USERNAME</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">pwcheck</span> <span class="o">=</span> <span class="n">Credentials</span><span class="o">.</span><span class="n">hashCreds</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">[</span><span class="n">Credentials</span><span class="o">.</span><span class="n">SALT_ENCODED_LEN</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pwcheck</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">pwcheck</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;logged_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="c1"># if we got here auth failed</span>
        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Wrong Username or Password&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="logout"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.logout">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="displayCarrierGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayCarrierGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriergroups&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriergroups/&lt;int:gwgroup&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayCarrierGroups</span><span class="p">(</span><span class="n">gwgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the carrier groups in the view</span>
<span class="sd">    :param gwgroup:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: track related dr_rules and update lists on delete</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">typeFilter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>

        <span class="c1"># res must be a list()</span>
        <span class="k">if</span> <span class="n">gwgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gwgroup</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">UAC</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span>
                <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">gwlist</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="n">UAC</span><span class="o">.</span><span class="n">r_username</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_password</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">r_domain</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_username</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_proxy</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">UAC</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span>
                <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">gwlist</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="n">UAC</span><span class="o">.</span><span class="n">r_username</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_password</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">r_domain</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_username</span><span class="p">,</span> <span class="n">UAC</span><span class="o">.</span><span class="n">auth_proxy</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">typeFilter</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;carriergroups.html&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="addUpdateCarrierGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateCarrierGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriergroups&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateCarrierGroups</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add or Update a group of carriers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;new_name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;new_name&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">authtype</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;authtype&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;authtype&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">r_username</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;r_username&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;r_username&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">auth_username</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;auth_username&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;auth_username&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">auth_password</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;auth_password&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;auth_password&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">auth_domain</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;auth_domain&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;auth_domain&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOMAIN</span>
        <span class="n">auth_proxy</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;auth_proxy&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;auth_proxy&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># format data</span>
        <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;userpwd&quot;</span><span class="p">:</span>
            <span class="n">auth_domain</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">auth_domain</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">auth_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Auth domain hostname/address is malformed&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth_proxy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">auth_proxy</span> <span class="o">=</span> <span class="n">auth_domain</span>
            <span class="n">auth_proxy</span> <span class="o">=</span> <span class="n">safeFormatSipUri</span><span class="p">(</span><span class="n">auth_proxy</span><span class="p">,</span> <span class="n">default_user</span><span class="o">=</span><span class="n">r_username</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">auth_proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Auth domain or proxy is malformed&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth_username</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">auth_username</span> <span class="o">=</span> <span class="n">r_username</span>

        <span class="c1"># Adding</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">GatewayGroups</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gwgroup</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">Gwgroup</span><span class="o">.</span><span class="n">id</span>

            <span class="c1"># Add auth_domain(aka registration server) to the gateway list</span>
            <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;userpwd&quot;</span><span class="p">:</span>
                <span class="n">Uacreg</span> <span class="o">=</span> <span class="n">UAC</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">r_username</span><span class="p">,</span> <span class="n">auth_password</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">,</span> <span class="n">auth_username</span><span class="o">=</span><span class="n">auth_username</span><span class="p">,</span> <span class="n">auth_proxy</span><span class="o">=</span><span class="n">auth_proxy</span><span class="p">,</span>
                    <span class="n">local_domain</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_IP_ADDR</span><span class="p">,</span> <span class="n">remote_domain</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">)</span>
                <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;-uac&quot;</span><span class="p">,</span> <span class="n">auth_domain</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Uacreg</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>

        <span class="c1"># Updating</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># config form</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">gwgroup_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Gwgroup</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="n">old_name</span> <span class="o">=</span> <span class="n">gwgroup_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">gwgroup_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>
                <span class="n">Gwgroup</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">gwgroup_fields</span><span class="p">)</span>

                <span class="n">Addr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;name:</span><span class="si">{}</span><span class="s2">-uac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_name</span><span class="p">)))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">Addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">addr_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                    <span class="n">addr_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">-uac&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                    <span class="n">Addr</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">addr_fields</span><span class="p">)</span>

            <span class="c1"># auth form</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;userpwd&quot;</span><span class="p">:</span>
                    <span class="c1"># update uacreg if exists, otherwise create</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UAC</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;l_username&#39;</span><span class="p">:</span> <span class="n">r_username</span><span class="p">,</span> <span class="s1">&#39;r_username&#39;</span><span class="p">:</span> <span class="n">r_username</span><span class="p">,</span> <span class="s1">&#39;auth_username&#39;</span><span class="p">:</span> <span class="n">auth_username</span><span class="p">,</span>
                         <span class="s1">&#39;auth_password&#39;</span><span class="p">:</span> <span class="n">auth_password</span><span class="p">,</span> <span class="s1">&#39;r_domain&#39;</span><span class="p">:</span> <span class="n">auth_domain</span><span class="p">,</span> <span class="s1">&#39;realm&#39;</span><span class="p">:</span> <span class="n">auth_domain</span><span class="p">,</span>
                         <span class="s1">&#39;auth_proxy&#39;</span><span class="p">:</span> <span class="n">auth_proxy</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="n">UAC</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">REG_ENABLED</span><span class="o">.</span><span class="n">value</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">Uacreg</span> <span class="o">=</span> <span class="n">UAC</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">r_username</span><span class="p">,</span> <span class="n">auth_password</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">,</span> <span class="n">auth_username</span><span class="o">=</span><span class="n">auth_username</span><span class="p">,</span>
                                     <span class="n">auth_proxy</span><span class="o">=</span><span class="n">auth_proxy</span><span class="p">,</span> <span class="n">local_domain</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_IP_ADDR</span><span class="p">,</span> <span class="n">remote_domain</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Uacreg</span><span class="p">)</span>

                    <span class="c1"># update address if exists, otherwise create</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;name:</span><span class="si">{}</span><span class="s2">-uac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;ip_addr&#39;</span><span class="p">:</span> <span class="n">auth_domain</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;-uac&quot;</span><span class="p">,</span> <span class="n">auth_domain</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># delete uacreg and address if they exist</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UAC</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;name:</span><span class="si">{}</span><span class="s2">-uac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayCarrierGroups</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="deleteCarrierGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deleteCarrierGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriergroupdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deleteCarrierGroups</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a group of carriers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span>
        <span class="n">gwlist</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwlist&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwlist&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">Addrs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;gwgroup:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)))</span>
        <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span>
        <span class="n">gwgroup_row</span> <span class="o">=</span> <span class="n">Gwgroup</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gwgroup_row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Uac</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UAC</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UAC</span><span class="o">.</span><span class="n">l_uuid</span> <span class="o">==</span> <span class="n">gwgroup_row</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">Uac</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># validate this group has gateways assigned to it</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">GWs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))))</span>
            <span class="n">GWs</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">Addrs</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Gwgroup</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayCarrierGroups</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="displayCarriers"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayCarriers">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriers&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriers/&lt;int:gwid&gt;&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriers/group/&lt;int:gwgroup&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayCarriers</span><span class="p">(</span><span class="n">gwid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">newgwid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the carriers table</span>
<span class="sd">    :param gwid:</span>
<span class="sd">    :param gwgroup:</span>
<span class="sd">    :param newgwid:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># carriers is a list of carriers matching query</span>
        <span class="c1"># carrier_routes is a list of associated rules for each carrier</span>
        <span class="n">carriers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">carrier_rules</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># get carrier by id</span>
        <span class="k">if</span> <span class="n">gwid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">carriers</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()]</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">gateway_rules</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
                    <span class="n">gateway_rules</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">ruleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">carrier_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">gateway_rules</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>

        <span class="c1"># get carriers by carrier group</span>
        <span class="k">elif</span> <span class="n">gwgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Gatewaygroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="c1"># check if any endpoints in group b4 converting to list(int)</span>
            <span class="k">if</span> <span class="n">Gatewaygroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">gwlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">gw</span><span class="p">)</span> <span class="k">for</span> <span class="n">gw</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))]</span>
                <span class="n">carriers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">gwlist</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="n">rules</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">gateway_id</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)):</span>
                    <span class="n">gateway_rules</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">gateway_id</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
                            <span class="n">gateway_rules</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">ruleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">carrier_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">gateway_rules</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>

        <span class="c1"># get all carriers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">carriers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">gateway</span> <span class="ow">in</span> <span class="n">carriers</span><span class="p">:</span>
                <span class="n">gateway_rules</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">gateway</span><span class="o">.</span><span class="n">gwid</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
                        <span class="n">gateway_rules</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">ruleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">carrier_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">gateway_rules</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;carriers.html&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">carriers</span><span class="p">,</span> <span class="n">routes</span><span class="o">=</span><span class="n">carrier_rules</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">new_gwid</span><span class="o">=</span><span class="n">newgwid</span><span class="p">,</span>
            <span class="n">reload_required</span><span class="o">=</span><span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="addUpdateCarriers"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateCarriers">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carriers&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateCarriers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add or Update a carrier</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>
    <span class="n">newgwid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span>
        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ip_addr&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ip_addr&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">strip</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Carrier hostname/address is required&quot;</span><span class="p">)</span>

        <span class="n">sip_addr</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">default_port</span><span class="o">=</span><span class="mi">5060</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sip_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is malformed&quot;</span><span class="p">)</span>
        <span class="n">host_addr</span> <span class="o">=</span> <span class="n">safeStripPort</span><span class="p">(</span><span class="n">sip_addr</span><span class="p">)</span>

        <span class="c1"># Adding</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">addr_id</span><span class="o">=</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">newgwid</span> <span class="o">=</span> <span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span>
                <span class="n">gwid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">newgwid</span><span class="p">)</span>
                <span class="n">Gatewaygroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroup</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">gwlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
                <span class="n">gwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span>
                <span class="n">Gatewaygroup</span><span class="o">.</span><span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gwlist</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">addr_id</span><span class="o">=</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>

        <span class="c1"># Updating</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">Gateway</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">sip_addr</span>
            <span class="n">Gateway</span><span class="o">.</span><span class="n">strip</span> <span class="o">=</span> <span class="n">strip</span>
            <span class="n">Gateway</span><span class="o">.</span><span class="n">pri_prefix</span> <span class="o">=</span> <span class="n">prefix</span>

            <span class="n">gw_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroup</span>

            <span class="c1"># if address exists update</span>
            <span class="n">address_exists</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;addr_id&#39;</span> <span class="ow">in</span> <span class="n">gw_fields</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Addr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                <span class="c1"># if entry is non existent handle in next block</span>
                <span class="k">if</span> <span class="n">Addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">address_exists</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">Addr</span><span class="o">.</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="n">host_addr</span>
                    <span class="n">addr_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                    <span class="n">addr_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">addr_fields</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroup</span>
                    <span class="n">Addr</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">addr_fields</span><span class="p">)</span>

            <span class="c1"># otherwise create the address</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">address_exists</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="c1"># gw_fields may be updated above so set after</span>
            <span class="n">Gateway</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">gw_fields</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayCarriers</span><span class="p">(</span><span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">,</span> <span class="n">newgwid</span><span class="o">=</span><span class="n">newgwid</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="deleteCarriers"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deleteCarriers">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/carrierdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deleteCarriers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a carrier</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span>
        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroup&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">related_rules</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;related_rules&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;related_rules&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">Gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span>
        <span class="n">Gateway_Row</span> <span class="o">=</span> <span class="n">Gateway</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">gw_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Gateway_Row</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># find associated gwgroup if not provided</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroup</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroup&#39;</span> <span class="ow">in</span> <span class="n">gw_fields</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># remove associated address if exists</span>
        <span class="k">if</span> <span class="s1">&#39;addr_id&#39;</span> <span class="ow">in</span> <span class="n">gw_fields</span><span class="p">:</span>
            <span class="n">Addr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gw_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span>
            <span class="n">Addr</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># grab any related carrier groups</span>
        <span class="n">Gatewaygroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM dr_gw_lists WHERE FIND_IN_SET(</span><span class="si">{}</span><span class="s1">, dr_gw_lists.gwlist)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwid</span><span class="p">))</span>

        <span class="c1"># remove gateway</span>
        <span class="n">Gateway</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># remove carrier from gwlist in carrier group</span>
        <span class="k">for</span> <span class="n">Gatewaygroup</span> <span class="ow">in</span> <span class="n">Gatewaygroups</span><span class="p">:</span>
            <span class="n">gwlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gatewaygroup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
            <span class="n">gwlist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">Gatewaygroup</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gwlist</span><span class="p">)},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># remove carrier from gwlist in carrier rules</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_rules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rule_ids</span> <span class="o">=</span> <span class="n">related_rules</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">rule_ids</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                <span class="n">gwlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
                <span class="n">gwlist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gwlist</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayCarriers</span><span class="p">(</span><span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroup</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="displayEndpointGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayEndpointGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/endpointgroups&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayEndpointGroups</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display Endpoint Groups / Endpoints in the view</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;endpointgroups.html&#39;</span><span class="p">,</span><span class="n">dsiprouter_ip</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_IP_ADDR</span><span class="p">,</span><span class="n">DEFAULT_auth_domain</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DOMAIN</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="displayCDRS"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayCDRS">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/cdrs&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayCDRS</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display Endpoint Groups / Endpoints in the view</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;cdrs.html&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<span class="c1"># TODO: why are we doing this weird api workaround, instead of making the gui and api separate??</span>
<div class="viewcode-block" id="addUpdateEndpointGroups"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateEndpointGroups">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/endpointgroups&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateEndpointGroups</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add or Update a PBX / Endpoint</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># form = stripDictVals(request.form.to_dict())</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: change ip_addr field to hostname or domainname, we already support this</span>
        <span class="c1"># gwid = form[&#39;gwid&#39;]</span>
        <span class="c1"># gwgroupid = request.form.get(&quot;gwgroup&quot;, None)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># ip_addr = request.form.get(&quot;ip_addr&quot;, None)</span>
        <span class="c1"># strip = form[&#39;strip&#39;] if len(form[&#39;strip&#39;]) &gt; 0 else &quot;0&quot;</span>
        <span class="c1"># prefix = form[&#39;prefix&#39;] if len(form[&#39;prefix&#39;]) &gt; 0 else &quot;&quot;</span>
        <span class="c1"># authtype = form[&#39;authtype&#39;]</span>
        <span class="c1"># fusionpbx_db_server = form[&#39;fusionpbx_db_server&#39;]</span>
        <span class="c1"># fusionpbx_db_username = form[&#39;fusionpbx_db_username&#39;]</span>
        <span class="c1"># fusionpbx_db_password = form[&#39;fusionpbx_db_password&#39;]</span>
        <span class="c1"># auth_username = form[&#39;auth_username&#39;]</span>
        <span class="c1"># auth_password = form[&#39;auth_password&#39;]</span>
        <span class="c1"># auth_domain = form[&#39;auth_domain&#39;] if len(form[&#39;auth_domain&#39;]) &gt; 0 else settings.DOMAIN</span>
        <span class="c1"># calllimit = form[&#39;calllimit&#39;] if len(form[&#39;calllimit&#39;]) &gt; 0 else &quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># multi_tenant_domain_enabled = False</span>
        <span class="c1"># multi_tenant_domain_type = dSIPMultiDomainMapping.FLAGS.TYPE_UNKNOWN.value</span>
        <span class="c1"># single_tenant_domain_enabled = False</span>
        <span class="c1"># single_tenant_domain_type = dSIPDomainMapping.FLAGS.TYPE_UNKNOWN.value</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">GatewayGroups</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gwgroup</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayEndpointGroups</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1"># TODO: is this route still in use?</span>
<div class="viewcode-block" id="deletePBX"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deletePBX">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pbxdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deletePBX</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a PBX / Endpoint</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">gwid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="n">gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span>
        <span class="n">gateway</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;name:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
        <span class="n">address</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">subscriber</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">rpid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">address</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">domainmultimapping</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="o">.</span><span class="n">pbx_id</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">domainmultimapping</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">load_only</span><span class="p">(</span><span class="s2">&quot;domain_list&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_list&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># make sure mapping has domains</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">domain_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">domains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">domain_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))))</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Domain</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Domain</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">domains</span><span class="p">))</span>
                <span class="n">domain</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># make sure mapping has attributes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">attr_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">attr_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))))</span>
                <span class="n">domainattrs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DomainAttrs</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DomainAttrs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
                <span class="n">domainattrs</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># delete the entry in the multi domain mapping table</span>
            <span class="n">domainmultimapping</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayEndpointGroups</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="displayInboundMapping"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayInboundMapping">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/inboundmapping&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayInboundMapping</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displaying of dr_rules table (inbound routes only)\n</span>
<span class="sd">    Partially Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">endpoint_filter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">)</span>
        <span class="n">carrier_filter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select * from (</span>
<span class="s2">    select r.ruleid, r.groupid, r.prefix, r.gwlist, r.description as rule_description, g.id as gwgroupid, g.description as gwgroup_description from dr_rules as r left join dr_gw_lists as g on g.id = REPLACE(r.gwlist, &#39;#&#39;, &#39;&#39;) where r.groupid = </span><span class="si">{flt_inbound}</span><span class="s2"></span>
<span class="s2">) as t1 left join (</span>
<span class="s2">    select hf.dr_ruleid as hf_ruleid, hf.dr_groupid as hf_groupid, hf.did as hf_fwddid, g.id as hf_gwgroupid from dsip_hardfwd as hf left join dr_rules as r on hf.dr_groupid = r.groupid left join dr_gw_lists as g on g.id = REPLACE(r.gwlist, &#39;#&#39;, &#39;&#39;) where hf.dr_groupid &lt;&gt; </span><span class="si">{flt_outbound}</span><span class="s2"></span>
<span class="s2">    union all</span>
<span class="s2">    select hf.dr_ruleid as hf_ruleid, hf.dr_groupid as hf_groupid, hf.did as hf_fwddid, NULL as hf_gwgroupid from dsip_hardfwd as hf left join dr_rules as r on hf.dr_ruleid = r.ruleid where hf.dr_groupid = </span><span class="si">{flt_outbound}</span><span class="s2"></span>
<span class="s2">) as t2 on t1.ruleid = t2.hf_ruleid left join (</span>
<span class="s2">    select ff.dr_ruleid as ff_ruleid, ff.dr_groupid as ff_groupid, ff.did as ff_fwddid, g.id as ff_gwgroupid from dsip_failfwd as ff left join dr_rules as r on ff.dr_groupid = r.groupid left join dr_gw_lists as g on g.id = REPLACE(r.gwlist, &#39;#&#39;, &#39;&#39;) where ff.dr_groupid &lt;&gt; </span><span class="si">{flt_outbound}</span><span class="s2"></span>
<span class="s2">    union all</span>
<span class="s2">    select ff.dr_ruleid as ff_ruleid, ff.dr_groupid as ff_groupid, ff.did as ff_fwddid, NULL as ff_gwgroupid from dsip_failfwd as ff left join dr_rules as r on ff.dr_ruleid = r.ruleid where ff.dr_groupid = </span><span class="si">{flt_outbound}</span><span class="s2"></span>
<span class="s2">) as t3 on t1.ruleid = t3.ff_ruleid&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flt_inbound</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">,</span> <span class="n">flt_outbound</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span>

        <span class="n">epgroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">endpoint_filter</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">gwgroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">endpoint_filter</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">carrier_filter</span><span class="p">)))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># sort endpoint groups by name</span>
        <span class="n">epgroups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="c1"># sort gateway groups by type then by name</span>
        <span class="n">gwgroups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>

        <span class="n">dids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLOWROUTE_ACCESS_KEY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLOWROUTE_SECRET_KEY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dids</span> <span class="o">=</span> <span class="n">numbers_api</span><span class="o">.</span><span class="n">getNumbers</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Flowroute Credentials Not Valid&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;inboundmapping.html&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">gwgroups</span><span class="o">=</span><span class="n">gwgroups</span><span class="p">,</span> <span class="n">epgroups</span><span class="o">=</span><span class="n">epgroups</span><span class="p">,</span> <span class="n">imported_dids</span><span class="o">=</span><span class="n">dids</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="addUpdateInboundMapping"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateInboundMapping">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/inboundmapping&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateInboundMapping</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adding and Updating of dr_rules table (inbound routes only)\n</span>
<span class="sd">    Partially Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># get form data</span>
        <span class="n">ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ruleid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;rulename&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;rulename&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hardfwd_enabled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;hardfwd_enabled&#39;</span><span class="p">])</span>
        <span class="n">hf_gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hf_gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_gwgroupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hf_groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_groupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hf_groupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hf_fwddid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_fwddid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hf_fwddid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">failfwd_enabled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;failfwd_enabled&#39;</span><span class="p">])</span>
        <span class="n">ff_gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ff_gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_gwgroupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ff_groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_groupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ff_groupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ff_fwddid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_fwddid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ff_fwddid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># we only support a single gwgroup at this time</span>
        <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># TODO: seperate redundant code into functions</span>

        <span class="c1"># Adding</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ruleid</span><span class="p">:</span>
            <span class="n">inserts</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># don&#39;t allow duplicate entries</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Duplicate DID&#39;s are not allowed&quot;</span><span class="p">)</span>

            <span class="n">IMap</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
            <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IMap</span><span class="p">)</span>

            <span class="c1"># find last rule in dr_rules</span>
            <span class="n">ruleid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=&#39;{}&#39; AND TABLE_NAME=&#39;dr_rules&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_NAME</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">hardfwd_enabled</span><span class="p">:</span>
                <span class="c1"># when gwgroup is set we need to create a dr_rule that maps to the gwlist of that gwgroup</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span>

                    <span class="c1"># find last forwarding rule</span>
                    <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                        <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                    <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                    <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">hfwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Hard Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">))</span>
                    <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd</span><span class="p">)</span>
                <span class="c1"># if no gwgroup selected we dont need dr_rules we set dr_groupid to FLT_OUTBOUND and we create hardfwd/failfwd rules</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                <span class="n">hfwd_htable</span> <span class="o">=</span> <span class="n">dSIPHardFwd</span><span class="p">(</span><span class="n">ruleid</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">,</span> <span class="n">fwdgroupid</span><span class="p">)</span>
                <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd_htable</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">failfwd_enabled</span><span class="p">:</span>
                <span class="c1"># when gwgroup is set we need to create a dr_rule that maps to the gwlist of that gwgroup</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span>

                    <span class="c1"># skip lookup if we just found the groupid</span>
                    <span class="k">if</span> <span class="n">fwdgroupid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># find last forwarding rule</span>
                        <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                            <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                        <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                        <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">ffwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Failover Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">))</span>
                    <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd</span><span class="p">)</span>
                <span class="c1"># if no gwgroup selected we dont need dr_rules we set dr_groupid to FLT_OUTBOUND and we create hardfwd/failfwd rules</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                <span class="n">ffwd_htable</span> <span class="o">=</span> <span class="n">dSIPFailFwd</span><span class="p">(</span><span class="n">ruleid</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">,</span> <span class="n">fwdgroupid</span><span class="p">)</span>
                <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd_htable</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">inserts</span><span class="p">)</span>

        <span class="c1"># Updating</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inserts</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">hardfwd_exists</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">hardfwd_enabled</span><span class="p">:</span>

                <span class="c1"># create fwd htable if it does not exist</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hardfwd_exists</span><span class="p">:</span>
                    <span class="c1"># only create rule if gwgroup has been selected</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span>

                        <span class="c1"># find last forwarding rule</span>
                        <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                            <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                        <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                        <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                        <span class="n">hfwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Hard Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">))</span>
                        <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd</span><span class="p">)</span>
                    <span class="c1"># if no gwgroup selected we dont need dr_rules we set dr_groupid to FLT_OUTBOUND and we create htable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                    <span class="n">hfwd_htable</span> <span class="o">=</span> <span class="n">dSIPHardFwd</span><span class="p">(</span><span class="n">ruleid</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">,</span> <span class="n">fwdgroupid</span><span class="p">)</span>
                    <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd_htable</span><span class="p">)</span>

                <span class="c1"># update existing fwd htable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># intially set fwdgroupid to update (if we create new rule it will change)</span>
                    <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hf_groupid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                    <span class="c1"># only update rule if one exists, which we know only happens if groupid != FLT_OUTBOUND</span>
                    <span class="k">if</span> <span class="n">hf_groupid</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">):</span>
                        <span class="c1"># if gwgroup is selected we update the rule, if not selected we delete the rule</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span>
                            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">hf_groupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;name:Hard Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">)},</span>
                                <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">hf_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">hf_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">hf_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                                <span class="n">hf_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if gwgroup is selected we create the rule</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_gwgroupid</span><span class="p">)</span>

                            <span class="c1"># find last forwarding rule</span>
                            <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                                <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                            <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                            <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                            <span class="n">hfwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Hard Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hf_fwddid</span><span class="p">))</span>
                            <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfwd</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="n">hf_fwddid</span><span class="p">,</span> <span class="s1">&#39;dr_groupid&#39;</span><span class="p">:</span> <span class="n">fwdgroupid</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># delete existing fwd htable and possibly fwd rule</span>
                <span class="k">if</span> <span class="n">hardfwd_exists</span><span class="p">:</span>
                    <span class="n">hf_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">hf_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                        <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">hf_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                        <span class="n">hf_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">hf_htable</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
                    <span class="n">hf_htable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">failfwd_exists</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">failfwd_enabled</span><span class="p">:</span>

                <span class="c1"># create fwd htable if it does not exist</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">failfwd_exists</span><span class="p">:</span>
                    <span class="c1"># only create rule if gwgroup has been selected</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span>

                        <span class="c1"># find last forwarding rule</span>
                        <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                            <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                        <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                        <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                        <span class="n">ffwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Failover Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">))</span>
                        <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd</span><span class="p">)</span>
                    <span class="c1"># if no gwgroup selected we dont need dr_rules we set dr_groupid to FLT_OUTBOUND and we create htable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                    <span class="n">ffwd_htable</span> <span class="o">=</span> <span class="n">dSIPFailFwd</span><span class="p">(</span><span class="n">ruleid</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">,</span> <span class="n">fwdgroupid</span><span class="p">)</span>
                    <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd_htable</span><span class="p">)</span>

                <span class="c1"># update existing fwd htable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># intially set fwdgroupid to update (if we create new rule it will change)</span>
                    <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ff_groupid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                    <span class="c1"># only update rule if one exists, which we know only happens if groupid != FLT_OUTBOUND</span>
                    <span class="k">if</span> <span class="n">ff_groupid</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">):</span>
                        <span class="c1"># if gwgroup is selected we update the rule, if not selected we delete the rule</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span>
                            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">ff_groupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;name:Failover Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">)},</span>
                                <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ff_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">ff_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">ff_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                                <span class="n">ff_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if gwgroup is selected we create the rule</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff_gwgroupid</span><span class="p">)</span>

                            <span class="c1"># find last forwarding rule</span>
                            <span class="n">lastfwd</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                                <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                            <span class="c1"># Start forwarding routes with a groupid set in settings (default is 20000)</span>
                            <span class="k">if</span> <span class="n">lastfwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fwdgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastfwd</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                            <span class="n">ffwd</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">fwdgroupid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;name:Failover Forward from </span><span class="si">{}</span><span class="s1"> to DID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ff_fwddid</span><span class="p">))</span>
                            <span class="n">inserts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffwd</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="n">ff_fwddid</span><span class="p">,</span> <span class="s1">&#39;dr_groupid&#39;</span><span class="p">:</span> <span class="n">fwdgroupid</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># delete existing fwd htable and possibly fwd rule</span>
                <span class="k">if</span> <span class="n">failfwd_exists</span><span class="p">:</span>
                    <span class="n">ff_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">ff_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                        <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">ff_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                        <span class="n">ff_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">ff_htable</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
                    <span class="n">ff_htable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inserts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">inserts</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayInboundMapping</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="deleteInboundMapping"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deleteInboundMapping">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/inboundmappingdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deleteInboundMapping</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deleting of dr_rules table (inbound routes only)\n</span>
<span class="sd">    Partially Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">]</span>
        <span class="n">hf_ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_ruleid&#39;</span><span class="p">]</span>
        <span class="n">hf_groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;hf_groupid&#39;</span><span class="p">]</span>
        <span class="n">ff_ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_ruleid&#39;</span><span class="p">]</span>
        <span class="n">ff_groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ff_groupid&#39;</span><span class="p">]</span>

        <span class="n">im_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
        <span class="n">im_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hf_ruleid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no dr_rules created for fwding without a gwgroup selected</span>
            <span class="n">hf_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">hf_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">hf_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="n">hf_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">hf_htable</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPHardFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
            <span class="n">hf_htable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_ruleid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no dr_rules created for fwding without a gwgroup selected</span>
            <span class="n">ff_rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">ff_groupid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">))</span> <span class="o">|</span>
                <span class="p">((</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">ff_rule</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="n">ff_rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ff_htable</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPFailFwd</span><span class="o">.</span><span class="n">dr_ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
            <span class="n">ff_htable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayInboundMapping</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="processInboundMappingImport"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.processInboundMappingImport">[docs]</a><span class="k">def</span> <span class="nf">processInboundMappingImport</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">override_gwgroupid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Adding</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">UPLOAD_FOLDER</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">csv_f</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_f</span><span class="p">:</span>
            <span class="c1"># skip header if present</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">prefix</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">override_gwgroupid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">override_gwgroupid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gwgroupid</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">IMap</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">gwgroupid</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">IMap</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="importInboundMapping"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.importInboundMapping">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/inboundmappingimport&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">importInboundMapping</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># get form data</span>
        <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;No file part&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;displayInboundMapping&#39;</span><span class="p">))</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
        <span class="c1"># if user does not select file, browser also</span>
        <span class="c1"># submit a empty part without filename</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;No selected file&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">ALLOWED_EXTENSIONS</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;csv&#39;</span><span class="p">])):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">UPLOAD_FOLDER</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="n">processInboundMappingImport</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">gwgroupid</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;X number of file were imported&#39;</span><span class="p">)</span>
            <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;displayInboundMapping&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="displayTeleBlock"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayTeleBlock">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/teleblock&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayTeleBlock</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display teleblock settings in view</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">teleblock</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_ENABLED</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_IP</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_PORT</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;media_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_IP</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;media_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_PORT</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;teleblock.html&#39;</span><span class="p">,</span> <span class="n">teleblock</span><span class="o">=</span><span class="n">teleblock</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="addUpdateTeleBlock"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpdateTeleBlock">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/teleblock&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpdateTeleBlock</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update teleblock config file settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># Update the teleblock settings</span>
        <span class="n">teleblock</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_GW_ENABLED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gw_enabled&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_GW_IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gw_ip&#39;</span><span class="p">]</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_GW_PORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gw_port&#39;</span><span class="p">]</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_MEDIA_IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;media_ip&#39;</span><span class="p">]</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s1">&#39;TELEBLOCK_MEDIA_PORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;media_port&#39;</span><span class="p">]</span>

        <span class="n">updateConfig</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">teleblock</span><span class="p">,</span> <span class="n">hot_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayTeleBlock</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="displayOutboundRoutes"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.displayOutboundRoutes">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/outboundroutes&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">displayOutboundRoutes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displaying of dr_rules table (outbound routes only)\n</span>
<span class="sd">    Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">carrier_filter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">)</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">)</span> <span class="o">&amp;</span>
             <span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">)))</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span>
            <span class="n">dSIPLCR</span><span class="p">,</span> <span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">==</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span>
            <span class="n">GatewayGroups</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span>
            <span class="n">dSIPLCR</span><span class="o">.</span><span class="n">from_prefix</span><span class="p">,</span> <span class="n">dSIPLCR</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span><span class="p">,</span>
            <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">routeid</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">),</span>
            <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">timerec</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;gwgroup_description&#39;</span><span class="p">),</span> <span class="n">GatewayGroups</span><span class="o">.</span><span class="n">gwlist</span><span class="p">)</span>

        <span class="n">cgroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">carrier_filter</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># sort carrier groups by name</span>
        <span class="n">cgroups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="n">teleblock</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_ENABLED</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_IP</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;gw_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_PORT</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;media_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_IP</span>
        <span class="n">teleblock</span><span class="p">[</span><span class="s2">&quot;media_port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_PORT</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;outboundroutes.html&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">cgroups</span><span class="o">=</span><span class="n">cgroups</span><span class="p">,</span> <span class="n">teleblock</span><span class="o">=</span><span class="n">teleblock</span><span class="p">,</span>
                               <span class="n">custom_routes</span><span class="o">=</span><span class="n">getCustomRoutes</span><span class="p">())</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="addUpateOutboundRoutes"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.addUpateOutboundRoutes">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/outboundroutes&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">addUpateOutboundRoutes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adding and Updating dr_rules table (outbound routes only)\n</span>
<span class="sd">    Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># get form data</span>
        <span class="n">ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ruleid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">groupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;groupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;groupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;groupid&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                                     <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;groupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>
        <span class="n">from_prefix</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;from_prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;from_prefix&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;from_prefix&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">timerec</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;timerec&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;timerec&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;priority&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">routeid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;routeid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;routeid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="ow">and</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">form</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Adding</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ruleid</span><span class="p">:</span>
            <span class="c1"># if len(from_prefix) &gt; 0 and len(prefix) == 0 :</span>
            <span class="c1">#    return displayOutboundRoutes()</span>
            <span class="k">if</span> <span class="n">from_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;from_prefix: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_prefix</span><span class="p">))</span>

                <span class="c1"># Grab the lastest groupid and increment</span>
                <span class="n">mlcr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">)</span> <span class="o">&amp;</span>
                                                <span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># Start LCR routes with a groupid in settings (default is 10000)</span>
                <span class="k">if</span> <span class="n">mlcr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">groupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">groupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mlcr</span><span class="o">.</span><span class="n">dr_groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">pattern</span> <span class="o">=</span> <span class="n">from_prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">prefix</span>

            <span class="n">OMap</span> <span class="o">=</span> <span class="n">OutboundRoutes</span><span class="p">(</span><span class="n">groupid</span><span class="o">=</span><span class="n">groupid</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">timerec</span><span class="o">=</span><span class="n">timerec</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                <span class="n">routeid</span><span class="o">=</span><span class="n">routeid</span><span class="p">,</span> <span class="n">gwlist</span><span class="o">=</span><span class="n">gwlist</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">OMap</span><span class="p">)</span>

            <span class="c1"># Add the lcr map</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">OLCRMap</span> <span class="o">=</span> <span class="n">dSIPLCR</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">from_prefix</span><span class="p">,</span> <span class="n">groupid</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">OLCRMap</span><span class="p">)</span>

        <span class="c1"># Updating</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no from_prefix we can update outbound route and remove any LCR entries</span>
            <span class="k">if</span> <span class="n">from_prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">oldgroupid</span> <span class="o">=</span> <span class="n">groupid</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">groupid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">groupid</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">):</span>
                    <span class="n">groupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span>

                <span class="c1"># Convert the dr_rule back to a default carrier rule</span>
                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                    <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Delete from LCR table using the old group id</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">==</span> <span class="n">oldgroupid</span><span class="p">)</span>
                <span class="n">d1</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># from_prefix given, we update outbound route and create/update LCR entry</span>
            <span class="k">elif</span> <span class="n">from_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># Setup pattern</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">from_prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">prefix</span>

                <span class="c1"># Check if pattern already exists</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">pattern</span> <span class="o">==</span> <span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                        <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                    <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Adding a From prefix to an existing To</span>
                <span class="k">elif</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">:</span>
                    <span class="c1"># Create a new groupid</span>
                    <span class="n">mlcr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">)</span> <span class="o">&amp;</span>
                                                    <span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                    <span class="c1"># Start LCR routes with a groupid set in settings (default is 10000)</span>
                    <span class="k">if</span> <span class="n">mlcr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">groupid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">groupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mlcr</span><span class="o">.</span><span class="n">dr_groupid</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># Setup new pattern</span>
                    <span class="n">pattern</span> <span class="o">=</span> <span class="n">from_prefix</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">prefix</span>

                    <span class="c1"># Add the lcr map</span>
                    <span class="k">if</span> <span class="n">pattern</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">OLCRMap</span> <span class="o">=</span> <span class="n">dSIPLCR</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">from_prefix</span><span class="p">,</span> <span class="n">groupid</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">OLCRMap</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                        <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                    <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Update existing pattern</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">groupid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">groupid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">):</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">==</span> <span class="n">groupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span> <span class="s1">&#39;from_prefix&#39;</span><span class="p">:</span> <span class="n">from_prefix</span><span class="p">})</span>

                    <span class="c1"># Update the dr_rules table</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                        <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                    <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># no to/from_prefix remove any LCR entries and update outbound route</span>
            <span class="c1"># TODO: not sure how to correlate stale LCR entries without old from-prefix (ideally we match by id)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Update the dr_rules table</span>
                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">:</span> <span class="n">groupid</span><span class="p">,</span> <span class="s1">&#39;timerec&#39;</span><span class="p">:</span> <span class="n">timerec</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                    <span class="s1">&#39;routeid&#39;</span><span class="p">:</span> <span class="n">routeid</span><span class="p">,</span> <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span>
                <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayOutboundRoutes</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="deleteOutboundRoute"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.deleteOutboundRoute">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/outboundroutesdelete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">deleteOutboundRoute</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deleting of dr_rules table (outbound routes only)\n</span>
<span class="sd">    Supports rule definitions for Kamailio Drouting module\n</span>
<span class="sd">    Documentation: `Drouting module &lt;https://kamailio.org/docs/modules/4.4.x/modules/drouting.html&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">stripDictVals</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="n">ruleid</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">]</span>

        <span class="n">OMap</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">OMap</span><span class="p">:</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLCR</span><span class="o">.</span><span class="n">dr_groupid</span> <span class="o">==</span> <span class="n">OMap</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span>
            <span class="n">d1</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OutboundRoutes</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">ruleid</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">displayOutboundRoutes</span><span class="p">()</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showError</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1"># TODO: deprecated, has been superseded by API endpoint reloadKamailio()</span>
<span class="c1"># @app.route(&#39;/reloadkam&#39;)</span>
<span class="c1"># def reloadkam():</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Soft Reload of kamailio modules and settings</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     prev_reload_val = globals.reload_required</span>
<span class="c1">#</span>
<span class="c1">#     try:</span>
<span class="c1">#         if not session.get(&#39;logged_in&#39;):</span>
<span class="c1">#             return redirect(url_for(&#39;index&#39;))</span>
<span class="c1">#</span>
<span class="c1">#         if (settings.DEBUG):</span>
<span class="c1">#             debugEndpoint()</span>
<span class="c1">#</span>
<span class="c1">#         # format some settings for kam config</span>
<span class="c1">#         dsip_api_url = settings.DSIP_API_PROTO + &#39;://&#39; + settings.DSIP_API_HOST + &#39;:&#39; + str(settings.DSIP_API_PORT)</span>
<span class="c1">#         if isinstance(settings.DSIP_API_TOKEN, bytes):</span>
<span class="c1">#             dsip_api_token = AES_CTR.decrypt(settings.DSIP_API_TOKEN).decode(&#39;utf-8&#39;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             dsip_api_token = settings.DSIP_API_TOKEN</span>
<span class="c1">#</span>
<span class="c1">#         # -- Reloading modules --</span>
<span class="c1">#         return_code = subprocess.call([&#39;kamcmd&#39;, &#39;permissions.addressReload&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;drouting.reload&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;domain.reload&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;dispatcher.reload&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;htable.reload&#39;, &#39;tofromprefix&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;htable.reload&#39;, &#39;maintmode&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;htable.reload&#39;, &#39;calllimit&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;htable.reload&#39;, &#39;gw2gwgroup&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;htable.reload&#39;, &#39;inbound_hardfwd&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;htable.reload&#39;, &#39;inbound_failfwd&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;htable.reload&#39;, &#39;inbound_prefixmap&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;uac.reg_reload&#39;])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;tls.reload&#39;])</span>
<span class="c1">#</span>
<span class="c1">#         # -- Updating settings --</span>
<span class="c1">#         return_code += subprocess.call(</span>
<span class="c1">#             [&#39;kamcmd&#39;, &#39;cfg.seti&#39;, &#39;teleblock&#39;, &#39;gw_enabled&#39;, str(settings.TELEBLOCK_GW_ENABLED)])</span>
<span class="c1">#</span>
<span class="c1">#         if settings.TELEBLOCK_GW_ENABLED:</span>
<span class="c1">#             return_code += subprocess.call(</span>
<span class="c1">#                 [&#39;kamcmd&#39;, &#39;cfg.sets&#39;, &#39;teleblock&#39;, &#39;gw_ip&#39;, str(settings.TELEBLOCK_GW_IP)])</span>
<span class="c1">#             return_code += subprocess.call(</span>
<span class="c1">#                 [&#39;kamcmd&#39;, &#39;cfg.seti&#39;, &#39;teleblock&#39;, &#39;gw_port&#39;, str(settings.TELEBLOCK_GW_PORT)])</span>
<span class="c1">#             return_code += subprocess.call(</span>
<span class="c1">#                 [&#39;kamcmd&#39;, &#39;cfg.sets&#39;, &#39;teleblock&#39;, &#39;media_ip&#39;, str(settings.TELEBLOCK_MEDIA_IP)])</span>
<span class="c1">#             return_code += subprocess.call(</span>
<span class="c1">#                 [&#39;kamcmd&#39;, &#39;cfg.seti&#39;, &#39;teleblock&#39;, &#39;media_port&#39;, str(settings.TELEBLOCK_MEDIA_PORT)])</span>
<span class="c1">#</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;cfg.sets&#39;, &#39;server&#39;, &#39;role&#39;, settings.ROLE])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;cfg.sets&#39;, &#39;server&#39;, &#39;api_server&#39;, dsip_api_url])</span>
<span class="c1">#         return_code += subprocess.call([&#39;kamcmd&#39;, &#39;cfg.sets&#39;, &#39;server&#39;, &#39;api_token&#39;, dsip_api_token])</span>
<span class="c1">#</span>
<span class="c1">#         session[&#39;last_page&#39;] = request.headers[&#39;Referer&#39;]</span>
<span class="c1">#</span>
<span class="c1">#         if return_code == 0:</span>
<span class="c1">#             status_code = 1</span>
<span class="c1">#             globals.reload_required = False</span>
<span class="c1">#         else:</span>
<span class="c1">#             status_code = 0</span>
<span class="c1">#             globals.reload_required = prev_reload_val</span>
<span class="c1">#         return json.dumps({&quot;status&quot;: status_code})</span>
<span class="c1">#</span>
<span class="c1">#     except http_exceptions.HTTPException as ex:</span>
<span class="c1">#         debugException(ex)</span>
<span class="c1">#         error = &quot;http&quot;</span>
<span class="c1">#         return showError(type=error)</span>
<span class="c1">#     except Exception as ex:</span>
<span class="c1">#         debugException(ex)</span>
<span class="c1">#         error = &quot;server&quot;</span>
<span class="c1">#         return showError(type=error)</span>

<span class="c1"># custom jinja filters</span>
<div class="viewcode-block" id="yesOrNoFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.yesOrNoFilter">[docs]</a><span class="k">def</span> <span class="nf">yesOrNoFilter</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Yes&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;No&quot;</span></div>

<div class="viewcode-block" id="noneFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.noneFilter">[docs]</a><span class="k">def</span> <span class="nf">noneFilter</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span></div>

<div class="viewcode-block" id="attrFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.attrFilter">[docs]</a><span class="k">def</span> <span class="nf">attrFilter</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span></div>

<div class="viewcode-block" id="domainTypeFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.domainTypeFilter">[docs]</a><span class="k">def</span> <span class="nf">domainTypeFilter</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Unknown&quot;</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Static&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Dynamic&quot;</span></div>

<div class="viewcode-block" id="imgFilter"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.imgFilter">[docs]</a><span class="k">def</span> <span class="nf">imgFilter</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">images_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">static_url_path</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">)</span>
    <span class="n">search_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">static_folder</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">search_path</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">images_url</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<span class="c1"># custom jinja context processors</span>
<div class="viewcode-block" id="injectReloadRequired"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.injectReloadRequired">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">context_processor</span>
<span class="k">def</span> <span class="nf">injectReloadRequired</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">reload_required</span><span class="o">=</span><span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="n">licensed</span><span class="o">=</span><span class="nb">globals</span><span class="o">.</span><span class="n">licensed</span><span class="p">)</span></div>

<div class="viewcode-block" id="injectSettings"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.injectSettings">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">context_processor</span>
<span class="k">def</span> <span class="nf">injectSettings</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span></div>

<span class="c1"># TODO: deprecated, using bjoern for WSGI server</span>
<span class="c1"># class CustomServer(Server):</span>
<span class="c1">#     &quot;&quot;&quot; Customize the Flask server with our settings &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self):</span>
<span class="c1">#         super().__init__(</span>
<span class="c1">#             host=settings.DSIP_HOST,</span>
<span class="c1">#             port=settings.DSIP_PORT</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         if len(settings.DSIP_SSL_CERT) &gt; 0 and len(settings.DSIP_SSL_KEY) &gt; 0:</span>
<span class="c1">#            self.ssl_crt = settings.DSIP_SSL_CERT</span>
<span class="c1">#            self.ssl_key = settings.DSIP_SSL_KEY</span>
<span class="c1">#</span>
<span class="c1">#         if settings.DEBUG == True:</span>
<span class="c1">#             self.use_debugger = True</span>
<span class="c1">#             self.use_reloader = True</span>
<span class="c1">#         else:</span>
<span class="c1">#             self.use_debugger = None</span>
<span class="c1">#             self.use_reloader = None</span>
<span class="c1">#             self.threaded = True</span>
<span class="c1">#             self.processes = 1</span>

<div class="viewcode-block" id="syncSettings"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.syncSettings">[docs]</a><span class="k">def</span> <span class="nf">syncSettings</span><span class="p">(</span><span class="n">new_fields</span><span class="o">=</span><span class="p">{},</span> <span class="n">update_net</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Synchronize settings.py with shared mem / db</span>

<span class="sd">    :param new_fields:      fields to override when syncing</span>
<span class="sd">    :type new_fields:       dict</span>
<span class="sd">    :param update_net:      if the network settings should be updated</span>
<span class="sd">    :type update_net:       bool</span>
<span class="sd">    :return:                None</span>
<span class="sd">    :rtype:                 None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># update ip&#39;s dynamically</span>
        <span class="c1"># TODO: need to create external fqdn resolution funcs</span>
        <span class="k">if</span> <span class="n">update_net</span><span class="p">:</span>
            <span class="n">net_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;INTERNAL_IP_ADDR&#39;</span><span class="p">:</span> <span class="n">getInternalIP</span><span class="p">(),</span>
                <span class="s1">&#39;INTERNAL_IP_NET&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">getInternalIP</span><span class="p">()</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s1">&#39;EXTERNAL_IP_ADDR&#39;</span><span class="p">:</span> <span class="n">getExternalIP</span><span class="p">(),</span>
                <span class="s1">&#39;EXTERNAL_FQDN&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_FQDN</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">net_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># sync settings from settings.py</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOAD_SETTINGS_FROM</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_ID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># need to grab any changes on disk b4 merging</span>
            <span class="n">reload</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

            <span class="c1"># format fields for DB</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
                <span class="p">[(</span><span class="s1">&#39;DSIP_ID&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_ID</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_CLUSTER_ID&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_CLUSTER_ID</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_CLUSTER_SYNC&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_CLUSTER_SYNC</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DSIP_PROTO&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PROTO</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_PORT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PORT</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DSIP_USERNAME&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_USERNAME</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_PASSWORD&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PASSWORD</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DSIP_IPC_PASS&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_IPC_PASS</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_API_PROTO&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_PROTO</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DSIP_API_PORT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_PORT</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_PRIV_KEY&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PRIV_KEY</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_PID_FILE&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PID_FILE</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DSIP_IPC_SOCK&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_IPC_SOCK</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_UNIX_SOCK&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_UNIX_SOCK</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_API_TOKEN&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_LOG_LEVEL&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DSIP_LOG_FACILITY&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_FACILITY</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_SSL_KEY&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_SSL_KEY</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DSIP_SSL_CERT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_SSL_CERT</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_SSL_EMAIL&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_SSL_EMAIL</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DSIP_CERTS_DIR&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_CERTS_DIR</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;VERSION&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;ROLE&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ROLE</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;GUI_INACTIVE_TIMEOUT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GUI_INACTIVE_TIMEOUT</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_HOST</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;KAM_DB_DRIVER&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_DRIVER</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;KAM_DB_TYPE&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_TYPE</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;KAM_DB_PORT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_PORT</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;KAM_DB_NAME&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_NAME</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;KAM_DB_USER&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_USER</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;KAM_DB_PASS&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_PASS</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;KAM_KAMCMD_PATH&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_KAMCMD_PATH</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;KAM_CFG_PATH&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_CFG_PATH</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;KAM_TLSCFG_PATH&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_TLSCFG_PATH</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;RTP_CFG_PATH&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">RTP_CFG_PATH</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;SQLALCHEMY_SQL_DEBUG&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">SQLALCHEMY_SQL_DEBUG</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;FLT_CARRIER&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_CARRIER</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;FLT_PBX&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;FLT_MSTEAMS&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_MSTEAMS</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;FLT_OUTBOUND&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_OUTBOUND</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;FLT_INBOUND&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;FLT_LCR_MIN&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_LCR_MIN</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;FLT_FWD_MIN&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_FWD_MIN</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DOMAIN&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOMAIN</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TELEBLOCK_GW_ENABLED&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_ENABLED</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;TELEBLOCK_GW_IP&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_IP</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TELEBLOCK_GW_PORT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_PORT</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;TELEBLOCK_MEDIA_IP&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_IP</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TELEBLOCK_MEDIA_PORT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_PORT</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;FLOWROUTE_ACCESS_KEY&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLOWROUTE_ACCESS_KEY</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;FLOWROUTE_SECRET_KEY&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLOWROUTE_SECRET_KEY</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;FLOWROUTE_API_ROOT_URL&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLOWROUTE_API_ROOT_URL</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;INTERNAL_IP_ADDR&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">INTERNAL_IP_ADDR</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;INTERNAL_IP_NET&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">INTERNAL_IP_NET</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;EXTERNAL_IP_ADDR&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_IP_ADDR</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;EXTERNAL_FQDN&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_FQDN</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;UPLOAD_FOLDER&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">UPLOAD_FOLDER</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CLOUD_PLATFORM&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">CLOUD_PLATFORM</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MAIL_SERVER&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_SERVER</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;MAIL_PORT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_PORT</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MAIL_USE_TLS&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_USE_TLS</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MAIL_USERNAME&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_USERNAME</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;MAIL_PASSWORD&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_PASSWORD</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MAIL_ASCII_ATTACHMENTS&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_ASCII_ATTACHMENTS</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;MAIL_DEFAULT_SENDER&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_DEFAULT_SENDER</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MAIL_DEFAULT_SUBJECT&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_DEFAULT_SUBJECT</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_fields</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">net_dict</span><span class="p">)</span>

            <span class="c1"># convert db specific fields</span>
            <span class="n">orig_kam_db_host</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_HOST</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_HOST</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;CALL update_dsip_settings(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()])),</span> <span class="n">fields</span><span class="p">)</span>

            <span class="c1"># revert db specific fields</span>
            <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_kam_db_host</span>

            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_ID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lastrowid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT LAST_INSERT_ID()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;DSIP_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastrowid</span>

        <span class="c1"># sync settings from dsip_settings table</span>
        <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOAD_SETTINGS_FROM</span> <span class="o">==</span> <span class="s1">&#39;db&#39;</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM dsip_settings WHERE DSIP_ID=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_ID</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_fields</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">net_dict</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]:</span>
                <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;KAM_DB_HOST&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># no other sync scenarios</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># update and reload settings file</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">updateConfig</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">hot_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">debugException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">printerr</span><span class="p">(</span><span class="s1">&#39;Could Not Update dsip_settings Database Table&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="sigHandler"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.sigHandler">[docs]</a><span class="k">def</span> <span class="nf">sigHandler</span><span class="p">(</span><span class="n">signum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Logic for trapped signals &quot;&quot;&quot;</span>
    <span class="c1"># ignore SIGHUP</span>
    <span class="k">if</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">IO</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;Received SIGHUP.. ignoring signal&quot;</span><span class="p">)</span>
    <span class="c1"># sync settings from db or file</span>
    <span class="k">elif</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">syncSettings</span><span class="p">()</span>
    <span class="c1"># sync settings from shared memory</span>
    <span class="k">elif</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR2</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">shared_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">getSettings</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">syncSettings</span><span class="p">(</span><span class="n">shared_settings</span><span class="p">)</span></div>

<div class="viewcode-block" id="replaceAppLoggers"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.replaceAppLoggers">[docs]</a><span class="k">def</span> <span class="nf">replaceAppLoggers</span><span class="p">(</span><span class="n">log_handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Handle configuration of web server loggers &quot;&quot;&quot;</span>

    <span class="c1"># close current log handlers</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">copy</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">copy</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># replace vanilla werkzeug and sqlalchemy log handler</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.engine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.engine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.dialects&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.dialects&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.pool&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.pool&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.orm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.orm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_LOG_LEVEL</span><span class="p">)</span></div>

<div class="viewcode-block" id="initApp"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.initApp">[docs]</a><span class="k">def</span> <span class="nf">initApp</span><span class="p">(</span><span class="n">flask_app</span><span class="p">):</span>
    <span class="c1"># Initialize Globals</span>
    <span class="nb">globals</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="c1"># Setup the Flask session manager with a random secret key</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

    <span class="c1"># Setup Flask timed url serializer</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EMAIL_SALT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urandomChars</span><span class="p">()</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TIMED_SERIALIZER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SECRET_KEY&quot;</span><span class="p">])</span>

    <span class="c1"># Add jinja2 filters</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;attrFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrFilter</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;yesOrNoFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yesOrNoFilter</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;noneFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noneFilter</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;imgFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgFilter</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;domainTypeFilter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domainTypeFilter</span>

    <span class="c1"># Add jinja2 functions</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="o">=</span><span class="nb">zip</span><span class="p">)</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">jsonLoads</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>

    <span class="c1"># Dynamically update settings</span>
    <span class="n">syncSettings</span><span class="p">(</span><span class="n">update_net</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># configs depending on updated settings go here</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="s2">&quot;development&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">else</span> <span class="s2">&quot;production&quot;</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span>

    <span class="c1"># Set flask JSON encoder</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">json_encoder</span> <span class="o">=</span> <span class="n">CreateEncoder</span><span class="p">()</span>

    <span class="c1"># Set session / cookie options</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">SESSION_PROTECTION</span><span class="o">=</span><span class="s1">&#39;strong&#39;</span><span class="p">,</span>
        <span class="n">SESSION_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">SESSION_COOKIE_HTTPONLY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">SESSION_COOKIE_SAMESITE</span><span class="o">=</span><span class="s1">&#39;Lax&#39;</span><span class="p">,</span>
        <span class="n">REMEMBER_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">REMEMBER_COOKIE_HTTPONLY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">REMEMBER_COOKIE_DURATION</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">GUI_INACTIVE_TIMEOUT</span><span class="p">),</span>
        <span class="n">PERMANENT_SESSION_LIFETIME</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">GUI_INACTIVE_TIMEOUT</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Setup ProxyFix middleware</span>
    <span class="n">flask_app</span> <span class="o">=</span> <span class="n">ProxyFix</span><span class="p">(</span><span class="n">flask_app</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># trap signals we handle</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="n">sigHandler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">sigHandler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR2</span><span class="p">,</span> <span class="n">sigHandler</span><span class="p">)</span>

    <span class="c1"># change umask to 660 before creating sockets</span>
    <span class="c1"># this allows members of the dsiprouter group access</span>
    <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="o">~</span><span class="mo">0o660</span> <span class="o">&amp;</span> <span class="mo">0o777</span><span class="p">)</span>

    <span class="c1"># start the Shared Memory Management server</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_IPC_SOCK</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_IPC_SOCK</span><span class="p">)</span>
    <span class="n">settings_manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># start the Flask App server</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_UNIX_SOCK</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_UNIX_SOCK</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PID_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pidfd</span><span class="p">:</span>
        <span class="n">pidfd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
    <span class="n">bjoern</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">flask_app</span><span class="p">,</span> <span class="s1">&#39;unix:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_UNIX_SOCK</span><span class="p">),</span> <span class="n">reuse_port</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="teardown"><a class="viewcode-back" href="../dev/dsiprouter.html#dsiprouter.teardown">[docs]</a><span class="k">def</span> <span class="nf">teardown</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings_manager</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">SessionLoader</span><span class="o">.</span><span class="n">session_factory</span><span class="o">.</span><span class="n">close_all</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PID_FILE</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">initApp</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">teardown</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright dOpenSource

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>