

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>modules.api.api_routes &mdash; dSIPRouter 0.64 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> dSIPRouter
          

          
          </a>

          
            
            
              <div class="version">
                0.64
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index.html">1.  User Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user/installing.html">1.2.1. Installing dSIPRouter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/command_line_options.html">1.3.1. Command Line Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/configuring.html">1.4.1. Configuring dSIPRouter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/carrier_groups.html">1.4.1.1. Carrier Groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/carrier_groups.html#adding-a-carrier">1.4.1.2. Adding a Carrier</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/pbxs_and_endpoints.html">1.4.1.3. PBX(s) and Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/pbxs_and_endpoints.html#inbound-did-mapping">1.4.1.4. Inbound DID Mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/domains.html">1.4.1.5. Adding a Domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/global_outbound_routes.html">1.4.1.6. Global Outbound Routes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/api.html">1.5.1. API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/use-cases.html">1.6.1. Use Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/resources.html">1.7.1. Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/supported_configurations.html">1.8.1. Supported Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/troubleshooting.html">1.9.1. Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user/upgrade.html">1.10.1. Upgrading dSIPRouter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user/upgrade_0.522_to_0.523.html">1.10.1.1.1. Upgrade dSIPRouter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/upgrade_0.50_to_0.51.html">1.10.1.2.1. Upgrade dSIPRouter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user/upgrade_0.621_to_0.63.html">1.10.1.3.1. Upgrade dSIPRouter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/index.html"> Developer Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/database.html">1.  database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/dsiprouter.html">2.  dsiprouter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/globals.html">3.  globals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/modules.html">4.  modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/settings.html">5.  settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/shared.html">6.  shared</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/sysloginit.html">7.  sysloginit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/util.html">8.  util</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../routes/index.html">2.  Routes Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../routes/routes.html">2.1.  routes</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dSIPRouter</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>modules.api.api_routes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for modules.api.api_routes</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">csv</span><span class="o">,</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span> <span class="k">as</span> <span class="nn">parse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">send_file</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">sql_exceptions</span><span class="p">,</span> <span class="n">and_</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">http_exceptions</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">SessionLoader</span><span class="p">,</span> <span class="n">DummySession</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">dSIPNotification</span><span class="p">,</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">DomainAttrs</span><span class="p">,</span> <span class="n">dSIPDomainMapping</span><span class="p">,</span> \
    <span class="n">dSIPMultiDomainMapping</span><span class="p">,</span> <span class="n">Dispatcher</span><span class="p">,</span> <span class="n">Gateways</span><span class="p">,</span> <span class="n">GatewayGroups</span><span class="p">,</span> <span class="n">Subscribers</span><span class="p">,</span> <span class="n">dSIPLeases</span><span class="p">,</span> <span class="n">dSIPMaintModes</span><span class="p">,</span> \
    <span class="n">dSIPCallLimits</span><span class="p">,</span> <span class="n">InboundMapping</span><span class="p">,</span> <span class="n">dSIPCDRInfo</span><span class="p">,</span> <span class="n">dSIPCertificates</span>
<span class="kn">from</span> <span class="nn">shared</span> <span class="kn">import</span> <span class="n">allowed_file</span><span class="p">,</span> <span class="n">dictToStrFields</span><span class="p">,</span> <span class="n">getExternalIP</span><span class="p">,</span> <span class="n">hostToIP</span><span class="p">,</span> <span class="n">isCertValid</span><span class="p">,</span> <span class="n">rowToDict</span><span class="p">,</span> <span class="n">showApiError</span><span class="p">,</span> \
    <span class="n">debugEndpoint</span><span class="p">,</span> <span class="n">StatusCodes</span><span class="p">,</span> <span class="n">strFieldsToDict</span><span class="p">,</span> <span class="n">IO</span><span class="p">,</span> <span class="n">getRequestData</span><span class="p">,</span> <span class="n">safeUriToHost</span><span class="p">,</span> <span class="n">safeStripPort</span>
<span class="kn">from</span> <span class="nn">util.notifications</span> <span class="kn">import</span> <span class="n">sendEmail</span>
<span class="kn">from</span> <span class="nn">util.security</span> <span class="kn">import</span> <span class="n">AES_CTR</span><span class="p">,</span> <span class="n">urandomChars</span>
<span class="kn">from</span> <span class="nn">util.file_handling</span> <span class="kn">import</span> <span class="n">isValidFile</span><span class="p">,</span> <span class="n">change_owner</span>
<span class="kn">from</span> <span class="nn">util.kamtls</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">util.cron</span> <span class="kn">import</span> <span class="n">getTaggedCronjob</span><span class="p">,</span> <span class="n">addTaggedCronjob</span><span class="p">,</span> <span class="n">updateTaggedCronjob</span><span class="p">,</span> <span class="n">deleteTaggedCronjob</span><span class="p">,</span> \
    <span class="n">cronIntervalToDescription</span>
<span class="kn">from</span> <span class="nn">util.letsencrypt</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">settings</span><span class="o">,</span> <span class="nn">globals</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># TODO: we need to standardize our response payload, preferably we can create a custom response class</span>
<span class="c1">#       proposed format:    { &#39;error&#39;: &#39;&#39;, &#39;msg&#39;: &#39;&#39;, &#39;kamreload&#39;: True/False, &#39;data&#39;: [] }</span>
<span class="c1">#                           error:      error string if one occurred (db|http|server)</span>
<span class="c1">#                           msg:        response message string</span>
<span class="c1">#                           kamreload:  bool, whether kam requires a reload</span>
<span class="c1">#                           data:       dict of data returned, if any</span>
<span class="c1">#       currently all the formats are different for each endpoint, we need to change this!!</span>
<span class="c1"># TODO: this is almost impossible to work on...</span>
<span class="c1">#       we need to abstract out common code between gui and api and standardize routes!</span>

<div class="viewcode-block" id="APIToken"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.APIToken">[docs]</a><span class="k">class</span> <span class="nc">APIToken</span><span class="p">:</span>
    <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="APIToken.__init__"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.APIToken.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">auth_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header_values</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">header_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="APIToken.isValid"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.APIToken.isValid">[docs]</a>    <span class="k">def</span> <span class="nf">isValid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
                <span class="c1"># Get Environment Variables if in debug mode</span>
                <span class="c1"># This is the only case we allow plain text token comparison</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DSIP_API_TOKEN&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span><span class="p">)</span>

                <span class="c1"># need to decrypt token</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">tokencheck</span> <span class="o">=</span> <span class="n">AES_CTR</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tokencheck</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span>

                <span class="k">return</span> <span class="n">tokencheck</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>

            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="api_security"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.api_security">[docs]</a><span class="k">def</span> <span class="nf">api_security</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">apiToken</span> <span class="o">=</span> <span class="n">APIToken</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">apiToken</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="n">accept_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;text/html&#39;</span> <span class="ow">in</span> <span class="n">accept_header</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">VERSION</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_UNAUTHORIZED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_UNAUTHORIZED</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="getKamailioStats"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.getKamailioStats">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/kamailio/stats&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">getKamailioStats</span><span class="p">():</span>
    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">stats_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">jsonrpc_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;tm.stats&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1:5060/api/kamailio&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">jsonrpc_payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">ex</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span>
            <span class="k">raise</span> <span class="n">ex</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Successfully retrieved kamailio stats&#39;</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span></div>


<div class="viewcode-block" id="reloadKamailio"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.reloadKamailio">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/kamailio/reload&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">reloadKamailio</span><span class="p">():</span>
    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="c1"># format some settings for kam config</span>
        <span class="n">dsip_api_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_PROTO</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="s1">&#39;127.0.0.1&#39;</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_PORT</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">dsip_api_token</span> <span class="o">=</span> <span class="n">AES_CTR</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dsip_api_token</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_API_TOKEN</span>

        <span class="c1"># Pulled tls.reload out of the reload process due to issues</span>
        <span class="c1">#{&#39;method&#39;: &#39;tls.reload&#39;, &#39;jsonrpc&#39;: &#39;2.0&#39;, &#39;id&#39;: 1},</span>

        <span class="n">reload_cmds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;permissions.addressReload&quot;</span><span class="p">,</span> <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;drouting.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;domain.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;tls.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;dispatcher.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;htable.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tofromprefix&quot;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;htable.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;maintmode&quot;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;htable.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;calllimit&quot;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;htable.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gw2gwgroup&quot;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;htable.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;inbound_hardfwd&quot;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;htable.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;inbound_failfwd&quot;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;htable.reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;inbound_prefixmap&quot;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;uac.reg_reload&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cfg.seti&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
             <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;teleblock&#39;</span><span class="p">,</span> <span class="s1">&#39;gw_enabled&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_ENABLED</span><span class="p">)]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cfg.sets&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ROLE</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cfg.sets&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;api_server&#39;</span><span class="p">,</span> <span class="n">dsip_api_url</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cfg.sets&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;api_token&#39;</span><span class="p">,</span> <span class="n">dsip_api_token</span><span class="p">]}</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_ENABLED</span><span class="p">:</span>
            <span class="n">reload_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cfg.sets&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;teleblock&#39;</span><span class="p">,</span> <span class="s1">&#39;gw_ip&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_IP</span><span class="p">)]})</span>
            <span class="n">reload_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cfg.seti&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;teleblock&#39;</span><span class="p">,</span> <span class="s1">&#39;gw_port&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_GW_PORT</span><span class="p">)]})</span>
            <span class="n">reload_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cfg.sets&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;teleblock&#39;</span><span class="p">,</span> <span class="s1">&#39;media_ip&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_IP</span><span class="p">)]})</span>
            <span class="n">reload_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cfg.seti&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;teleblock&#39;</span><span class="p">,</span> <span class="s1">&#39;media_port&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">TELEBLOCK_MEDIA_PORT</span><span class="p">)]})</span>

        <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="n">reload_cmds</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cmd: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmdset</span><span class="p">))</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1:5060/api/kamailio&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">cmdset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reason</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">ex</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span>
                <span class="k">raise</span> <span class="n">ex</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Kamailio reload succeeded&#39;</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span></div>


<span class="c1"># TODO: this func actually adds an endpoint lease</span>
<span class="c1">#       it should be renamed and changed to use POST method</span>
<span class="c1"># TODO: the last lease id/username generated must be tracked (just query DB)</span>
<span class="c1">#       and used to determine next lease id, otherwise conflicts may occur</span>
<div class="viewcode-block" id="getEndpointLease"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.getEndpointLease">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpoint/lease&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">getEndpointLease</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="n">DEF_PASSWORD_LEN</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">lease_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;email parameter is missing&quot;</span><span class="p">)</span>

        <span class="n">ttl</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ttl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ttl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;time to live (ttl) parameter is missing&quot;</span><span class="p">)</span>

        <span class="c1"># Generate some values</span>
        <span class="n">rand_num</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;lease&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rand_num</span><span class="p">)</span>
        <span class="n">auth_username</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">auth_password</span> <span class="o">=</span> <span class="n">urandomChars</span><span class="p">(</span><span class="n">DEF_PASSWORD_LEN</span><span class="p">)</span>
        <span class="n">auth_domain</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOMAIN</span>

        <span class="c1"># Set some defaults</span>
        <span class="n">host_addr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">strip</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Add the Gateways table</span>
        <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Add the Subscribers table</span>
        <span class="n">Subscriber</span> <span class="o">=</span> <span class="n">Subscribers</span><span class="p">(</span><span class="n">auth_username</span><span class="p">,</span> <span class="n">auth_password</span><span class="p">,</span> <span class="n">auth_domain</span><span class="p">,</span> <span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Subscriber</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Add to the Leases table</span>
        <span class="n">Lease</span> <span class="o">=</span> <span class="n">dSIPLeases</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span><span class="p">,</span> <span class="n">Subscriber</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ttl</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Lease</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">lease_data</span><span class="p">[</span><span class="s1">&#39;leaseid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lease</span><span class="o">.</span><span class="n">id</span>
        <span class="n">lease_data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_username</span>
        <span class="n">lease_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_password</span>
        <span class="n">lease_data</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_domain</span>
        <span class="n">lease_data</span><span class="p">[</span><span class="s1">&#39;ttl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttl</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lease_data</span><span class="p">)</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="revokeEndpointLease"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.revokeEndpointLease">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpoint/lease/&lt;int:leaseid&gt;/revoke&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">revokeEndpointLease</span><span class="p">(</span><span class="n">leaseid</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># Query the Lease ID</span>
        <span class="n">Lease</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPLeases</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPLeases</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">leaseid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="c1"># Remove the entry in the Subscribers table</span>
        <span class="n">Subscriber</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">Lease</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Subscriber</span><span class="p">)</span>

        <span class="c1"># Remove the entry in the Gateway table</span>
        <span class="n">Gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">Lease</span><span class="o">.</span><span class="n">gwid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>

        <span class="c1"># Remove the entry in the Lease table</span>
        <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Lease</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># TODO: is this endpoint still used?</span>
<div class="viewcode-block" id="updateEndpoint"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.updateEndpoint">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpoint/&lt;int:id&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">updateEndpoint</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># Covert JSON message to Dictionary Object</span>
        <span class="n">request_payload</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>

        <span class="c1"># Only handling the maintmode attribute on this release</span>
        <span class="k">if</span> <span class="s1">&#39;maintmode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;maintmode attribute missing&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;maintmode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">MaintMode</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPMaintModes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPMaintModes</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">MaintMode</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">MaintMode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;maintmode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Lookup Gateway ip adddess</span>
            <span class="n">Gateway</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Gateway</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">MaintMode</span> <span class="o">=</span> <span class="n">dSIPMaintModes</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaintMode</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;endpoint </span><span class="si">{}</span><span class="s2"> is already in maintmode&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">response_payload</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># TODO: we should optimize this and cleanup reused code</span>
<div class="viewcode-block" id="handleInboundMapping"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.handleInboundMapping">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/inboundmapping&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">handleInboundMapping</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint for Inbound DID Rule Mapping</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># use a whitelist to avoid possible SQL Injection vulns</span>
    <span class="n">VALID_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ruleid&#39;</span><span class="p">,</span> <span class="s1">&#39;did&#39;</span><span class="p">}</span>

    <span class="c1"># use a whitelist to avoid possible buffer overflow vulns or crashes</span>
    <span class="n">VALID_REQUEST_DATA_ARGS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;did&#39;</span><span class="p">,</span> <span class="s1">&#39;servers&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">}</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># =========================================</span>
        <span class="c1"># get rule for DID mapping or list of rules</span>
        <span class="c1"># =========================================</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
            <span class="c1"># sanity check</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_REQUEST_ARGS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request argument not recognized&quot;</span><span class="p">)</span>

            <span class="c1"># get single rule by ruleid</span>
            <span class="n">rule_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ruleid&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">rule_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">rowToDict</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ruleid&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">],</span> <span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;servers&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;gwlist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)}</span>
                    <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Rule Found&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No Matching Rule Found&#39;</span>

            <span class="c1"># get single rule by did</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">did_pattern</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;did&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">did_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">InboundMapping</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">did_pattern</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">rowToDict</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ruleid&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">],</span> <span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;servers&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;gwlist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)}</span>
                        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DID Found&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No Matching DID Found&#39;</span>

                <span class="c1"># get list of rules</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">rowToDict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ruleid&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ruleid&#39;</span><span class="p">],</span> <span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;servers&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;gwlist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)}</span>
                            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Rules Found&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No Rules Found&#39;</span>

            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

        <span class="c1"># ===========================</span>
        <span class="c1"># create rule for DID mapping</span>
        <span class="c1"># ===========================</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>

            <span class="c1"># sanity checks</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request data argument not recognized&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;servers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Servers to map DID to are required&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Primary Server missing or More than 2 Servers Provided&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;did&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;DID is required&#39;</span><span class="p">)</span>

            <span class="c1"># TODO: we should be checking dr_gateways table to make sure the servers exist</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">])):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="c1">#_ = int(data[&#39;servers&#39;][i])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Invalid Server ID&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;did&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">DID_PREFIX_ALLOWED_CHARS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span>
                        <span class="s1">&#39;DID improperly formatted. Allowed characters: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DID_PREFIX_ALLOWED_CHARS</span><span class="p">)))</span>

            <span class="n">gwlist</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">])</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;did&#39;</span><span class="p">]</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

            <span class="c1"># don&#39;t allow duplicate entries</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Duplicate DID&#39;s are not allowed&quot;</span><span class="p">)</span>
            <span class="n">IMap</span> <span class="o">=</span> <span class="n">InboundMapping</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">gwlist</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">IMap</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Rule Created&#39;</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

        <span class="c1"># ===========================</span>
        <span class="c1"># update rule for DID mapping</span>
        <span class="c1"># ===========================</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
            <span class="c1"># sanity check</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_REQUEST_ARGS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request argument not recognized&quot;</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>
            <span class="n">updates</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># sanity checks</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request data argument not recognized&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;did&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="s1">&#39;servers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;No data args supplied, {did, and servers} is required&quot;</span><span class="p">)</span>
            <span class="c1"># TODO: we should be checking dr_gateways table to make sure the servers exist</span>
            <span class="k">if</span> <span class="s1">&#39;servers&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Primary Server missing or More than 2 Servers Provided&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">])):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                            <span class="c1">#_ = int(data[&#39;servers&#39;][i])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Invalid Server ID&#39;</span><span class="p">)</span>
                <span class="n">updates</span><span class="p">[</span><span class="s1">&#39;gwlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;did&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;did&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">DID_PREFIX_ALLOWED_CHARS</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span>
                            <span class="s1">&#39;DID improperly formatted. Allowed characters: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DID_PREFIX_ALLOWED_CHARS</span><span class="p">)))</span>
                <span class="n">updates</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;did&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">updates</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;name:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

            <span class="c1"># update single rule by ruleid</span>
            <span class="n">rule_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ruleid&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">rule_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">updates</span><span class="p">,</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Rule Updated&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No Matching Rule Found&#39;</span>

            <span class="c1"># update single rule by did</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">did_pattern</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;did&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">did_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">InboundMapping</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">did_pattern</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="n">updates</span><span class="p">,</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Rule Updated&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No Matching Rule Found&#39;</span>

                <span class="c1"># no other options</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;One of the following is required: {ruleid, or did}&#39;</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

        <span class="c1"># ===========================</span>
        <span class="c1"># delete rule for DID mapping</span>
        <span class="c1"># ===========================</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
            <span class="c1"># sanity check</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_REQUEST_ARGS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request argument not recognized&quot;</span><span class="p">)</span>

            <span class="c1"># delete single rule by ruleid</span>
            <span class="n">rule_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ruleid&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">InboundMapping</span><span class="o">.</span><span class="n">ruleid</span> <span class="o">==</span> <span class="n">rule_id</span><span class="p">)</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># delete single rule by did</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">did_pattern</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;did&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">did_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rule</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InboundMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">InboundMapping</span><span class="o">.</span><span class="n">groupid</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_INBOUND</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">InboundMapping</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">did_pattern</span><span class="p">)</span>
                    <span class="n">rule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># no other options</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;One of the following is required: {ruleid, or did}&#39;</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Rule Deleted&#39;</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

        <span class="c1"># not possible</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown Error Occurred&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="handleNotificationRequest"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.handleNotificationRequest">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/notification/gwgroup&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">handleNotificationRequest</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint for Sending Notifications</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># use a whitelist to avoid possible buffer overflow vulns or crashes</span>
    <span class="n">VALID_REQUEST_DATA_ARGS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;text_body&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;gwid&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;sender&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># ============================</span>
        <span class="c1"># create and send notification</span>
        <span class="c1"># ============================</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>

        <span class="c1"># sanity checks</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request data argument &#39;</span><span class="si">{}</span><span class="s2">&#39; not recognized&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request data argument &#39;</span><span class="si">{}</span><span class="s2">&#39; not valid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;gwgroupid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Gateway Group ID is required&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Notification Type is required&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;text_body&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Text Body is required&#39;</span><span class="p">)</span>

        <span class="c1"># lookup recipients</span>
        <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">)</span>
        <span class="n">notif_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">notification_row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">notif_type</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">notification_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span><span class="p">(</span><span class="s1">&#39;DB Entry Missing for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)))</span>

        <span class="c1"># customize message based on type</span>
        <span class="n">gwid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;gwid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">gw_row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span> <span class="k">if</span> <span class="n">gwid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">gw_name</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">gw_row</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">gw_row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">gwgroup_row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">gwgroup_name</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">gwgroup_row</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">gwgroup_row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">notif_type</span> <span class="o">==</span> <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">TYPE_OVERLIMIT</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;html_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;&lt;html&gt;&lt;head&gt;&lt;style&gt;.error{{border: 1px solid; margin: 10px 0px; padding: 15px 10px 15px 50px; background-color: #FF5555;}}&lt;/style&gt;&lt;/head&gt;&#39;</span>
                <span class="s1">&#39;&lt;body&gt;&lt;div class=&quot;error&quot;&gt;&lt;strong&gt;Call Limit Exceeded in Endpoint Group [</span><span class="si">{}</span><span class="s1">] on Endpoint [</span><span class="si">{}</span><span class="s1">]&lt;/strong&gt;&lt;/div&gt;&lt;/body&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">gwgroup_name</span><span class="p">,</span> <span class="n">gw_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">notif_type</span> <span class="o">==</span> <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">TYPE_GWFAILURE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;html_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;&lt;html&gt;&lt;head&gt;&lt;style&gt;.error{{border: 1px solid; margin: 10px 0px; padding: 15px 10px 15px 50px; background-color: #FF5555;}}&lt;/style&gt;&lt;/head&gt;&#39;</span>
                <span class="s1">&#39;&lt;body&gt;&lt;div class=&quot;error&quot;&gt;&lt;strong&gt;Failure Detected in Endpoint Group [</span><span class="si">{}</span><span class="s1">] on Endpoint [</span><span class="si">{}</span><span class="s1">]&lt;/strong&gt;&lt;/div&gt;&lt;/body&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">gwgroup_name</span><span class="p">,</span> <span class="n">gw_name</span><span class="p">)</span>

        <span class="c1"># # get attachments if any uploaded</span>
        <span class="c1"># data[&#39;attachments&#39;] = []</span>
        <span class="c1"># if len(request.files) &gt; 0:</span>
        <span class="c1">#     for upload in request.files:</span>
        <span class="c1">#         if upload.filename != &#39;&#39; and isValidFile(upload.filename):</span>
        <span class="c1">#             data[&#39;attachments&#39;].append(upload)</span>

        <span class="c1"># TODO: we only support email at this time, add support for slack</span>
        <span class="k">if</span> <span class="n">notification_row</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">METHOD_EMAIL</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;recipients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">notification_row</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
            <span class="n">sendEmail</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">notification_row</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">METHOD_SLACK</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Email Sent&#39;</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="deleteEndpointGroup"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.deleteEndpointGroup">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpointgroups/&lt;int:gwgroupid&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">deleteEndpointGroup</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">endpointgroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">endpointgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">endpointgroup</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="s2">&quot;The endpoint group doesn&#39;t exist&quot;</span><span class="p">)</span>

        <span class="n">calllimit</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCallLimits</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCallLimits</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">calllimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calllimit</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">subscriber</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">rpid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subscriber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subscriber</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">typeFilter</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">wgroup:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span>
        <span class="n">endpoints</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">typeFilter</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">endpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">address_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
                <span class="n">description_dict</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">endpoint</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;addr_id&#39;</span> <span class="ow">in</span> <span class="n">description_dict</span><span class="p">:</span>
                    <span class="n">address_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description_dict</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span>
            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">address_ids</span><span class="p">))</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">endpoints</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">notifications</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">notifications</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">notifications</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cdrinfo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cdrinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cdrinfo</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">deleteTaggedCronjob</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span>
            <span class="c1"># if not deleteTaggedCronjob(gwgroupid):</span>
            <span class="c1">#    raise Exception(&#39;Crontab entry could not be deleted&#39;)</span>

        <span class="n">domainmapping</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="o">.</span><span class="n">pbx_id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domainmapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domainmapping</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="getEndpointGroup"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.getEndpointGroup">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpointgroups/&lt;int:gwgroupid&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">getEndpointGroup</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">gwgroup_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">endpointgroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">endpointgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">endpointgroup</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="s2">&quot;Endpoint Group Does Not Exist&quot;</span><span class="p">)</span>

        <span class="c1"># Send back the gateway groupid that was requested</span>
        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroupid</span>

        <span class="n">calllimit</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCallLimits</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCallLimits</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">calllimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;calllimit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calllimit</span><span class="o">.</span><span class="n">limit</span>

        <span class="c1"># Check to see if a subscriber record exists.  If so, auth is userpwd</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">subscriber</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">rpid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">subscriber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">auth</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;userpwd&quot;</span>
            <span class="n">auth</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">username</span>
            <span class="n">auth</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">password</span>
            <span class="n">auth</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">domain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auth</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ip&quot;</span>

        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth</span>

        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;endpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">endpointList</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">endpointList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">endpointGatewayList</span> <span class="o">=</span> <span class="n">endpointList</span><span class="o">.</span><span class="n">gwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">endpoints</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">endpointGatewayList</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
                <span class="n">ep</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">ep</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">gwid</span>
                <span class="n">ep</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">address</span>
                <span class="n">ep</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">endpoint</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">ep</span><span class="p">[</span><span class="s1">&#39;maintmode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;endpoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
                <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">strip</span>
                <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">pri_prefix</span>

        <span class="c1"># Notifications</span>
        <span class="n">notifications</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">notification</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
            <span class="c1"># if notification.type == dSIPNotification.FLAGS.TYPE_MAXCALLLIMIT.value:</span>
            <span class="k">if</span> <span class="n">notification</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">notifications</span><span class="p">[</span><span class="s1">&#39;overmaxcalllimit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">notification</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># if notification.type == dSIPNotification.FLAGS.TYPE_ENDPOINTFAILURE.value:</span>
            <span class="k">if</span> <span class="n">notification</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">notifications</span><span class="p">[</span><span class="s1">&#39;endpointfailure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">notification</span><span class="o">.</span><span class="n">value</span>

        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">notifications</span>

        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">domainmapping</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="o">.</span><span class="n">pbx_id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">domainmapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
            <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbhost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domainmapping</span><span class="o">.</span><span class="n">db_host</span>
            <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbuser&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domainmapping</span><span class="o">.</span><span class="n">db_username</span>
            <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbpass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domainmapping</span><span class="o">.</span><span class="n">db_password</span>

        <span class="c1"># CDR info</span>
        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cdrinfo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cdrinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">][</span><span class="s1">&#39;cdr_email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdrinfo</span><span class="o">.</span><span class="n">email</span>
            <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">][</span><span class="s1">&#39;cdr_send_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdrinfo</span><span class="o">.</span><span class="n">send_interval</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gwgroup_data</span><span class="p">)</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Endpoint group found&#39;</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># TODO: should reuse getEndpointGroup() function and return all settings for each gwgroup</span>
<div class="viewcode-block" id="listEndpointGroups"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.listEndpointGroups">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpointgroups&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">listEndpointGroups</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">typeFilter</span> <span class="o">=</span> <span class="s2">&quot;%type:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">endpointgroups</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">typeFilter</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">endpointgroup</span> <span class="ow">in</span> <span class="n">endpointgroups</span><span class="p">:</span>
            <span class="c1"># Grap the description field, which is comma seperated key/value pair</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">endpointgroup</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

            <span class="c1"># append summary of endpoint group data</span>
            <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;gwgroupid&#39;</span><span class="p">:</span> <span class="n">endpointgroup</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">endpointgroup</span><span class="o">.</span><span class="n">gwlist</span>
            <span class="p">})</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Endpoint groups found&#39;</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="updateEndpointGroups"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.updateEndpointGroups">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpointgroups&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpointgroups/&lt;int:gwgroupid&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">updateEndpointGroups</span><span class="p">(</span><span class="n">gwgroupid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update a single Endpoint Group\n</span>
<span class="sd">    The gwgroupid can be provided in url path or payload</span>

<span class="sd">    ===============</span>
<span class="sd">    Request Payload</span>
<span class="sd">    ===============</span>

<span class="sd">    .. code-block:: json</span>

<span class="sd">        {</span>
<span class="sd">            name: &lt;string&gt;,</span>
<span class="sd">            calllimit: &lt;int&gt;,</span>
<span class="sd">            auth: {</span>
<span class="sd">                type: &quot;ip&quot;|&quot;userpwd&quot;,</span>
<span class="sd">                user: &lt;string&gt;</span>
<span class="sd">                pass: &lt;string&gt;</span>
<span class="sd">                domain: &lt;string&gt;</span>
<span class="sd">            },</span>
<span class="sd">            endpoints [</span>
<span class="sd">                {</span>
<span class="sd">                    gwid:&lt;int&gt;,</span>
<span class="sd">                    hostname:&lt;string&gt;,</span>
<span class="sd">                    description:&lt;string&gt;</span>
<span class="sd">                },</span>
<span class="sd">                ...</span>
<span class="sd">            ],</span>
<span class="sd">            strip: &lt;int&gt;,</span>
<span class="sd">            prefix: &lt;string&gt;,</span>
<span class="sd">            notifications: {</span>
<span class="sd">                overmaxcalllimit: &lt;string&gt;,</span>
<span class="sd">                endpointfailure: &lt;string&gt;</span>
<span class="sd">            },</span>
<span class="sd">            cdr: {</span>
<span class="sd">                cdr_email: &lt;string&gt;,</span>
<span class="sd">                cdr_send_interval: &lt;string&gt;</span>
<span class="sd">            }</span>
<span class="sd">            fusionpbx: {</span>
<span class="sd">                enabled: &lt;bool&gt;,</span>
<span class="sd">                dbhost: &lt;string&gt;,</span>
<span class="sd">                dbuser: &lt;string&gt;,</span>
<span class="sd">                dbpass: &lt;string&gt;</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">    ================</span>
<span class="sd">    Response Payload</span>
<span class="sd">    ================</span>

<span class="sd">    .. code-block:: json</span>

<span class="sd">        {</span>
<span class="sd">            error: &lt;string&gt;,</span>
<span class="sd">            msg: &lt;string&gt;,</span>
<span class="sd">            kamreload: &lt;bool&gt;,</span>
<span class="sd">            data: [</span>
<span class="sd">                {</span>
<span class="sd">                    gwgroupid: &lt;int&gt;,</span>
<span class="sd">                    endpoints: [</span>
<span class="sd">                        &lt;int&gt;,</span>
<span class="sd">                        ...</span>
<span class="sd">                    ]</span>
<span class="sd">                }</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># use a whitelist to avoid possible buffer overflow vulns or crashes</span>
    <span class="n">VALID_REQUEST_DATA_ARGS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gwgroupid&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;calllimit&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;auth&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                               <span class="s2">&quot;strip&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;cdr&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                               <span class="s2">&quot;fusionpbx&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;endpoints&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">}</span>

    <span class="c1"># ensure requred args are provided</span>
    <span class="n">REQUIRED_ARGS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">}</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">gwgroup_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># get request data</span>
        <span class="n">request_payload</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">gwgroupid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gwgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span>
            <span class="n">gwgroupid_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span>
            <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroupid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;gwgroupid&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
                <span class="n">gwgroupid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">])</span>
                <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroupid</span>
            <span class="n">gwgroupid_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span>

        <span class="c1"># sanity checks</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request argument &#39;</span><span class="si">{}</span><span class="s2">&#39; not recognized&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">request_payload</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request argument &#39;</span><span class="si">{}</span><span class="s2">&#39; not valid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">REQUIRED_ARGS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REQUIRED_ARGS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request argument &#39;</span><span class="si">{}</span><span class="s2">&#39; is required&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">DID_PREFIX_ALLOWED_CHARS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span>
                        <span class="s2">&quot;Request argument &#39;prefix&#39; not valid. Allowed characters: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DID_PREFIX_ALLOWED_CHARS</span><span class="p">)))</span>

        <span class="c1"># Update gateway group name</span>
        <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">Gwgroup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="s1">&#39;gwgroup does not exist&#39;</span><span class="p">)</span>
        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroupid</span>
        <span class="n">gwgroup_desc_dict</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Gwgroup</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="n">gwgroup_desc_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">Gwgroup</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">gwgroup_desc_dict</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Update concurrent call limit</span>
        <span class="n">calllimit</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;calllimit&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;calllimit&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">calllimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">calllimit</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCallLimits</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCallLimits</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">calllimit</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">CallLimit</span> <span class="o">=</span> <span class="n">dSIPCallLimits</span><span class="p">(</span><span class="n">gwgroupid_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">calllimit</span><span class="p">))</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CallLimit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Calllimit</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCallLimits</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCallLimits</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Calllimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Calllimit</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># runtime defaults for this route</span>
        <span class="n">strip</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;strip&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">authtype</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="s1">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="ow">and</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Update the AuthType userpwd settings</span>
        <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;userpwd&quot;</span><span class="p">:</span>
            <span class="n">authuser</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;user&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">authpass</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;pass&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;pass&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">authdomain</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;domain&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOMAIN</span>
            <span class="n">authdomain</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">authdomain</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">authuser</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">authpass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Auth username or password invalid&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">authdomain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Auth domain is malformed&quot;</span><span class="p">)</span>

            <span class="c1"># Get the existing username and domain_name if it exists</span>
            <span class="n">currentSubscriberInfo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">rpid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">currentSubscriberInfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">authuser</span> <span class="o">==</span> <span class="n">currentSubscriberInfo</span><span class="o">.</span><span class="n">username</span> <span class="ow">and</span> <span class="n">authpass</span> <span class="o">==</span> <span class="n">currentSubscriberInfo</span><span class="o">.</span><span class="n">password</span> \
                        <span class="ow">and</span> <span class="n">authdomain</span> <span class="o">==</span> <span class="n">currentSubscriberInfo</span><span class="o">.</span><span class="n">domain</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># The subscriber info is the same - no need to update</span>
                <span class="c1"># Check if the new username and domain is unique</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">authuser</span><span class="p">,</span>
                                                    <span class="n">Subscribers</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">authdomain</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Subscriber username already taken&quot;</span><span class="p">)</span>
                    <span class="c1"># Update the Subscriber Info</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">currentSubscriberInfo</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">authuser</span>
                        <span class="n">currentSubscriberInfo</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">authpass</span>
                        <span class="n">currentSubscriberInfo</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">authdomain</span>
            <span class="c1"># Create a new Suscriber entry</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Subscriber</span> <span class="o">=</span> <span class="n">Subscribers</span><span class="p">(</span><span class="n">authuser</span><span class="p">,</span> <span class="n">authpass</span><span class="p">,</span> <span class="n">authdomain</span><span class="p">,</span> <span class="n">gwgroupid_str</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Subscriber</span><span class="p">)</span>

        <span class="c1"># Delete the Subscriber info if IP is selected</span>
        <span class="k">elif</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;ip&quot;</span><span class="p">:</span>
            <span class="n">subscriber</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">rpid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subscriber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">subscriber</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Update endpoints</span>
        <span class="c1"># Get List of existing endpoints</span>
        <span class="c1"># If endpoint sent over is not in the existing endpoint list then remove it</span>
        <span class="n">gwgroup_filter</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">wgroup:</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupid_str</span><span class="p">)</span>
        <span class="n">current_endpoints_lut</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">x</span><span class="o">.</span><span class="n">gwid</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="s1">&#39;description_dict&#39;</span><span class="p">:</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">description</span><span class="p">)}</span> \
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">gwgroup_filter</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">updated_endpoints</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;endpoints&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;endpoints&quot;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">unprocessed_endpoints_lut</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">gwlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># endpoints to add unconditionally</span>
        <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">updated_endpoints</span><span class="p">:</span>
            <span class="n">gwid</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;gwid&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># If gwid is empty then this is a new endpoint</span>
            <span class="k">if</span> <span class="n">gwid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hostname</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hostname&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is required&quot;</span><span class="p">)</span>

                <span class="n">sip_addr</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">default_port</span><span class="o">=</span><span class="mi">5060</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sip_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is malformed&quot;</span><span class="p">)</span>

                <span class="c1"># add gateway info for each endpoint</span>
                <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;ip&quot;</span><span class="p">:</span>
                    <span class="c1"># for ip auth we must create address records for the endpoint</span>
                    <span class="n">host_addr</span> <span class="o">=</span> <span class="n">safeStripPort</span><span class="p">(</span><span class="n">sip_addr</span><span class="p">)</span>

                    <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">,</span>
                                       <span class="n">addr_id</span><span class="o">=</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we know this a new endpoint so we don&#39;t have to check for any address records here</span>
                    <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">gwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span><span class="p">)</span>

            <span class="c1"># Process separately</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unprocessed_endpoints_lut</span><span class="p">[</span><span class="n">gwid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
                <span class="p">}</span>

        <span class="c1"># conditionally adding/updating/deleting endpoints (using set theory)</span>
        <span class="c1"># generally endpoints won&#39;t be added with gwid specified but its possible</span>
        <span class="n">current_gwids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_endpoints_lut</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">updated_gwids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unprocessed_endpoints_lut</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">add_gwids</span> <span class="o">=</span> <span class="n">updated_gwids</span> <span class="o">-</span> <span class="n">current_gwids</span>
        <span class="n">upd_gwids</span> <span class="o">=</span> <span class="n">current_gwids</span> <span class="o">&amp;</span> <span class="n">updated_gwids</span>
        <span class="n">del_gwids</span> <span class="o">=</span> <span class="n">current_gwids</span> <span class="o">-</span> <span class="n">updated_gwids</span>

        <span class="c1"># conditional endpoints to add</span>
        <span class="k">for</span> <span class="n">gwid</span> <span class="ow">in</span> <span class="n">add_gwids</span><span class="p">:</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="n">unprocessed_endpoints_lut</span><span class="p">[</span><span class="n">gwid</span><span class="p">]</span>

            <span class="n">hostname</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hostname&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is required&quot;</span><span class="p">)</span>

            <span class="n">sip_addr</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">default_port</span><span class="o">=</span><span class="mi">5060</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sip_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is malformed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;ip&quot;</span><span class="p">:</span>
                <span class="c1"># for ip auth we must create address records for the endpoint</span>
                <span class="n">host_addr</span> <span class="o">=</span> <span class="n">safeStripPort</span><span class="p">(</span><span class="n">sip_addr</span><span class="p">)</span>

                <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">addr_id</span><span class="o">=</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we know this a new endpoint so we don&#39;t have to check for any address records here</span>
                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)</span>

            <span class="c1"># we ignore the given gwid and allow DB to assign one instead</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">gwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span><span class="p">)</span>

        <span class="c1"># conditional endpoints to update</span>
        <span class="k">for</span> <span class="n">gwid</span> <span class="ow">in</span> <span class="n">upd_gwids</span><span class="p">:</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="n">unprocessed_endpoints_lut</span><span class="p">[</span><span class="n">gwid</span><span class="p">]</span>
            <span class="n">current_endpoint</span> <span class="o">=</span> <span class="n">current_endpoints_lut</span><span class="p">[</span><span class="n">gwid</span><span class="p">]</span>

            <span class="c1"># allow updating single fields (if not provided set to current value)</span>
            <span class="n">endpoint_fields</span> <span class="o">=</span> <span class="n">current_endpoint</span><span class="p">[</span><span class="s1">&#39;description_dict&#39;</span><span class="p">]</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hostname&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="n">current_endpoint</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="n">endpoint_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">endpoint_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is required&quot;</span><span class="p">)</span>

            <span class="n">sip_addr</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">default_port</span><span class="o">=</span><span class="mi">5060</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sip_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is malformed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;ip&quot;</span><span class="p">:</span>
                <span class="c1"># for ip auth we must create address records for the endpoint</span>
                <span class="n">host_addr</span> <span class="o">=</span> <span class="n">safeStripPort</span><span class="p">(</span><span class="n">sip_addr</span><span class="p">)</span>

                <span class="c1"># if address exists update, otherwise create it</span>
                <span class="n">address_exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="s1">&#39;addr_id&#39;</span> <span class="ow">in</span> <span class="n">endpoint_fields</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoint_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Addr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">endpoint_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">Addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">address_exists</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="n">Addr</span><span class="o">.</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="n">host_addr</span>
                        <span class="n">addr_fields</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                        <span class="n">addr_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                        <span class="n">addr_fields</span><span class="p">[</span><span class="s1">&#39;gwgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroupid_str</span>
                        <span class="n">Addr</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">addr_fields</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">address_exists</span><span class="p">:</span>
                    <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="n">endpoint_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if not using ip auth make sure we delete any old address records for the endpoint</span>
                <span class="k">if</span> <span class="s1">&#39;addr_id&#39;</span> <span class="ow">in</span> <span class="n">endpoint_fields</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoint_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Addr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">endpoint_fields</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">Addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">Addr</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># remove addr_id field from endpoint description</span>
                    <span class="n">endpoint_fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;addr_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># update the endpoint</span>
            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span> <span class="o">==</span> <span class="n">gwid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">dictToStrFields</span><span class="p">(</span><span class="n">endpoint_fields</span><span class="p">),</span> <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="s2">&quot;strip&quot;</span><span class="p">:</span> <span class="n">strip</span><span class="p">,</span>
                 <span class="s2">&quot;pri_prefix&quot;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">gwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gwid</span><span class="p">)</span>

        <span class="c1"># conditional endpoints to delete</span>
        <span class="c1"># we also cleanup house here in case of stray entries</span>
        <span class="n">del_gateways</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">del_gwids</span><span class="p">))</span>
        <span class="n">del_gateways_cleanup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Gateways</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">gwgroup_filter</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Gateways</span><span class="o">.</span><span class="n">gwid</span><span class="o">.</span><span class="n">notin_</span><span class="p">(</span><span class="n">gwlist</span><span class="p">))</span>
        <span class="c1"># make sure we delete any associated address entries</span>
        <span class="n">del_addr_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gateway</span> <span class="ow">in</span> <span class="n">del_gateways</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">del_gateways_cleanup</span><span class="p">):</span>
            <span class="n">description_dict</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">gateway</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;addr_id&#39;</span> <span class="ow">in</span> <span class="n">description_dict</span><span class="p">:</span>
                <span class="n">del_addr_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description_dict</span><span class="p">[</span><span class="s1">&#39;addr_id&#39;</span><span class="p">])</span>
        <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">del_addr_ids</span><span class="p">))</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">del_gateways</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">del_gateways_cleanup</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># set return gwlist and update the endpoint group&#39;s gwlist</span>
        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;endpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwlist</span>
        <span class="n">gwlist_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">gw</span><span class="p">)</span> <span class="k">for</span> <span class="n">gw</span> <span class="ow">in</span> <span class="n">gwlist</span><span class="p">])</span>
        <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;gwlist&quot;</span><span class="p">:</span> <span class="n">gwlist_str</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Update notifications</span>
        <span class="k">if</span> <span class="s1">&#39;notifications&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="n">overmaxcalllimit</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">][</span><span class="s1">&#39;overmaxcalllimit&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;overmaxcalllimit&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">endpointfailure</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">][</span><span class="s1">&#39;endpointfailure&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;endpointfailure&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">overmaxcalllimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Try to update</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">overmaxcalllimit</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="c1"># Otherwise Add</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">notif_type</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">notification</span> <span class="o">=</span> <span class="n">dSIPNotification</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">notif_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">overmaxcalllimit</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
            <span class="c1"># Remove</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">endpointfailure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Try to update</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">endpointfailure</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="c1"># Otherwise Add</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">notif_type</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">notification</span> <span class="o">=</span> <span class="n">dSIPNotification</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">notif_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">endpointfailure</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
            <span class="c1"># Remove</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPNotification</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Update CDR</span>
        <span class="k">if</span> <span class="s1">&#39;cdr&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="n">cdr_email</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">][</span><span class="s1">&#39;cdr_email&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;cdr_email&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">cdr_send_interval</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">][</span><span class="s1">&#39;cdr_send_interval&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;cdr_send_interval&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdr_email</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdr_send_interval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Try to update</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">cdr_email</span><span class="p">,</span> <span class="s2">&quot;send_interval&quot;</span><span class="p">:</span> <span class="n">cdr_send_interval</span><span class="p">},</span>
                        <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">updateTaggedCronjob</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">cdr_send_interval</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Crontab entry could not be updated&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cdrinfo</span> <span class="o">=</span> <span class="n">dSIPCDRInfo</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">cdr_email</span><span class="p">,</span> <span class="n">cdr_send_interval</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cdrinfo</span><span class="p">)</span>
                    <span class="n">cron_cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> cdr sendreport </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PROJECT_DIR</span> <span class="o">+</span> <span class="s1">&#39;/gui/dsiprouter_cron.py&#39;</span><span class="p">),</span>
                                                             <span class="n">gwgroupid_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">addTaggedCronjob</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">cdr_send_interval</span><span class="p">,</span> <span class="n">cron_cmd</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Crontab entry could not be created&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Remove CDR Info</span>
                <span class="n">cdrinfo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cdrinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cdrinfo</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">deleteTaggedCronjob</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Crontab entry could not be deleted&#39;</span><span class="p">)</span>

        <span class="c1"># Update FusionPBX</span>
        <span class="k">if</span> <span class="s1">&#39;fusionpbx&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="n">fusionpbxenabled</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;enabled&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fusionpbxdbhost</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbhost&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;dbhost&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fusionpbxdbuser</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbuser&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;dbuser&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fusionpbxdbpass</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbpass&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;dbpass&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># Convert fusionpbxenabled variable to int</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fusionpbxenabled</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">fusionpbxenabled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fusionpbxenabled</span><span class="p">)</span>
            <span class="c1"># Update</span>
            <span class="k">if</span> <span class="n">fusionpbxenabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Update</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="o">.</span><span class="n">pbx_id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;pbx_id&quot;</span><span class="p">:</span> <span class="n">gwgroupid</span><span class="p">,</span> <span class="s2">&quot;db_host&quot;</span><span class="p">:</span> <span class="n">fusionpbxdbhost</span><span class="p">,</span> <span class="s2">&quot;db_username&quot;</span><span class="p">:</span> <span class="n">fusionpbxdbuser</span><span class="p">,</span>
                         <span class="s2">&quot;db_password&quot;</span><span class="p">:</span> <span class="n">fusionpbxdbpass</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Create new record</span>
                    <span class="n">domainmapping</span> <span class="o">=</span> <span class="n">dSIPMultiDomainMapping</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">fusionpbxdbhost</span><span class="p">,</span> <span class="n">fusionpbxdbuser</span><span class="p">,</span> <span class="n">fusionpbxdbpass</span><span class="p">,</span>
                                                           <span class="nb">type</span><span class="o">=</span><span class="n">dSIPMultiDomainMapping</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">TYPE_FUSIONPBX</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">domainmapping</span><span class="p">)</span>
            <span class="c1"># Delete</span>
            <span class="k">elif</span> <span class="n">fusionpbxenabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPMultiDomainMapping</span><span class="o">.</span><span class="n">pbx_id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                    <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Endpoint group updated&#39;</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gwgroup_data</span><span class="p">)</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># TODO: fix up like updateEnpointGroups()</span>
<div class="viewcode-block" id="addEndpointGroups"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.addEndpointGroups">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/endpointgroups&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">addEndpointGroups</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpointGroupType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a single Endpoint Group</span>

<span class="sd">    ===============</span>
<span class="sd">    Request Payload</span>
<span class="sd">    ===============</span>

<span class="sd">    .. code-block:: json</span>

<span class="sd">        {</span>
<span class="sd">            name: &lt;string&gt;,</span>
<span class="sd">            calllimit: &lt;int&gt;,</span>
<span class="sd">            auth: {</span>
<span class="sd">                type: &quot;ip&quot;|&quot;userpwd&quot;,</span>
<span class="sd">                user: &lt;string&gt;</span>
<span class="sd">                pass: &lt;string&gt;</span>
<span class="sd">                domain: &lt;string&gt;</span>
<span class="sd">            },</span>
<span class="sd">            endpoints [</span>
<span class="sd">                {</span>
<span class="sd">                    hostname:&lt;string&gt;,</span>
<span class="sd">                    description:&lt;string&gt;</span>
<span class="sd">                },</span>
<span class="sd">                ...</span>
<span class="sd">            ],</span>
<span class="sd">            strip: &lt;int&gt;,</span>
<span class="sd">            prefix: &lt;string&gt;,</span>
<span class="sd">            notifications: {</span>
<span class="sd">                overmaxcalllimit: &lt;string&gt;,</span>
<span class="sd">                endpointfailure: &lt;string&gt;</span>
<span class="sd">            },</span>
<span class="sd">            cdr: {</span>
<span class="sd">                cdr_email: &lt;string&gt;,</span>
<span class="sd">                cdr_send_interval: &lt;string&gt;</span>
<span class="sd">            }</span>
<span class="sd">            fusionpbx: {</span>
<span class="sd">                enabled: &lt;bool&gt;,</span>
<span class="sd">                dbhost: &lt;string&gt;,</span>
<span class="sd">                dbuser: &lt;string&gt;,</span>
<span class="sd">                dbpass: &lt;string&gt;</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">    ================</span>
<span class="sd">    Response Payload</span>
<span class="sd">    ================</span>

<span class="sd">    .. code-block:: json</span>

<span class="sd">        {</span>
<span class="sd">            error: &lt;string&gt;,</span>
<span class="sd">            msg: &lt;string&gt;,</span>
<span class="sd">            kamreload: &lt;bool&gt;,</span>
<span class="sd">            data: [</span>
<span class="sd">                {</span>
<span class="sd">                    gwgroupid: &lt;int&gt;,</span>
<span class="sd">                    endpoints: [</span>
<span class="sd">                        &lt;int&gt;,</span>
<span class="sd">                        ...</span>
<span class="sd">                    ]</span>
<span class="sd">                }</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># use a whitelist to avoid possible buffer overflow vulns or crashes</span>
    <span class="n">VALID_REQUEST_DATA_ARGS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;calllimit&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;auth&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;strip&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;cdr&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;fusionpbx&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;endpoints&quot;</span><span class="p">:</span> <span class="nb">list</span>
    <span class="p">}</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">gwgroup_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Convert Request message to Dictionary Object</span>
            <span class="n">request_payload</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the data parameter as the payload</span>
            <span class="n">request_payload</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># sanity checks</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request argument &#39;</span><span class="si">{}</span><span class="s2">&#39; not recognized&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">request_payload</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">VALID_REQUEST_DATA_ARGS</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request argument &#39;</span><span class="si">{}</span><span class="s2">&#39; not valid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">DID_PREFIX_ALLOWED_CHARS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span>
                        <span class="s2">&quot;Request argument &#39;prefix&#39; not valid. Allowed characters: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DID_PREFIX_ALLOWED_CHARS</span><span class="p">)))</span>

        <span class="c1"># Process Gateway Name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">Gwgroup</span> <span class="o">=</span> <span class="n">GatewayGroups</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gwgroup</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">gwgroupid</span> <span class="o">=</span> <span class="n">Gwgroup</span><span class="o">.</span><span class="n">id</span>
        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;gwgroupid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwgroupid</span>

        <span class="n">calllimit</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;calllimit&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;calllimit&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">calllimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">calllimit</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">CallLimit</span> <span class="o">=</span> <span class="n">dSIPCallLimits</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">calllimit</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CallLimit</span><span class="p">)</span>

        <span class="c1"># runtime defaults for this route</span>
        <span class="n">strip</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;strip&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">authtype</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="s1">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="ow">and</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;userpwd&quot;</span><span class="p">:</span>
            <span class="c1"># Store Endpoint IP&#39;s in address tables</span>
            <span class="n">authuser</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;user&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> \
                   <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">authpass</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;pass&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> \
                   <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;pass&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">authdomain</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;domain&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> \
                   <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;domain&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOMAIN</span>
            <span class="n">authdomain</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">authdomain</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">authuser</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">authpass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Auth username or password invalid&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">authdomain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Auth domain is malformed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Subscribers</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">authuser</span><span class="p">,</span>
                                            <span class="n">Subscribers</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">authdomain</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">sql_exceptions</span><span class="o">.</span><span class="n">SQLAlchemyError</span><span class="p">(</span>
                    <span class="s1">&#39;DB Entry Taken for Username </span><span class="si">{}</span><span class="s1"> in Domain </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">authuser</span><span class="p">,</span> <span class="n">authdomain</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Subscriber</span> <span class="o">=</span> <span class="n">Subscribers</span><span class="p">(</span><span class="n">authuser</span><span class="p">,</span> <span class="n">authpass</span><span class="p">,</span> <span class="n">authdomain</span><span class="p">,</span> <span class="n">gwgroupid</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Subscriber</span><span class="p">)</span>

        <span class="c1"># Enable FusionPBX Support for the Endpoint Group</span>
        <span class="k">if</span> <span class="s1">&#39;fusionpbx&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="n">fusionpbxenabled</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;enabled&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fusionpbxdbonly</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbonly&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;dbonly&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fusionpbxdbhost</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbhost&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;dbhost&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fusionpbxdbuser</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbuser&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;dbuser&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fusionpbxdbpass</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">][</span><span class="s1">&#39;dbpass&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;dbpass&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;fusionpbx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># Convert fusionpbxenabled variable to int</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fusionpbxenabled</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">fusionpbxenabled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fusionpbxenabled</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fusionpbxenabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">domainmapping</span> <span class="o">=</span> <span class="n">dSIPMultiDomainMapping</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">fusionpbxdbhost</span><span class="p">,</span> <span class="n">fusionpbxdbuser</span><span class="p">,</span> <span class="n">fusionpbxdbpass</span><span class="p">,</span>
                                                       <span class="nb">type</span><span class="o">=</span><span class="n">dSIPMultiDomainMapping</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">TYPE_FUSIONPBX</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">domainmapping</span><span class="p">)</span>

                <span class="c1"># Add the FusionPBX server as an Endpoint if it&#39;s not just the DB server</span>
                <span class="k">if</span> <span class="n">fusionpbxdbonly</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fusionpbxdbonly</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">endpoint</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fusionpbxdbhost</span>
                    <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FusionPBX Server&quot;</span>
                    <span class="k">if</span> <span class="s2">&quot;endpoints&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
                        <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;endpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;endpoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="c1"># Setup Endpoints</span>
        <span class="n">endpoints</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;endpoints&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;endpoints&quot;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">gwlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># endpoints to add unconditionally</span>
        <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;hostname&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is required&quot;</span><span class="p">)</span>

            <span class="c1"># For MSTeams the third attrs field contains the Domain it relates too</span>
            <span class="c1"># the first two fields are always stripped and replaced by our triggers</span>
            <span class="k">if</span> <span class="n">endpointGroupType</span> <span class="o">==</span> <span class="s2">&quot;msteams&quot;</span> <span class="ow">and</span> <span class="n">domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="s1">&#39;0,0,</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">sip_addr</span> <span class="o">=</span> <span class="n">safeUriToHost</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">default_port</span><span class="o">=</span><span class="mi">5060</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sip_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Endpoint hostname/address is malformed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">authtype</span> <span class="o">==</span> <span class="s2">&quot;ip&quot;</span><span class="p">:</span>
                <span class="n">host_addr</span> <span class="o">=</span> <span class="n">safeStripPort</span><span class="p">(</span><span class="n">sip_addr</span><span class="p">)</span>

                <span class="n">Addr</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">addr_id</span><span class="o">=</span><span class="n">Addr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Gateways</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sip_addr</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLT_PBX</span><span class="p">,</span> <span class="n">gwgroup</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Gateway</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">gwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">gwid</span><span class="p">)</span>

        <span class="c1"># set return gwlist and update the endpoint group&#39;s gwlist</span>
        <span class="n">gwgroup_data</span><span class="p">[</span><span class="s1">&#39;endpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwlist</span>
        <span class="n">gwlist_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">gw</span><span class="p">)</span> <span class="k">for</span> <span class="n">gw</span> <span class="ow">in</span> <span class="n">gwlist</span><span class="p">])</span>

        <span class="c1"># Update the GatewayGroup with the lists of gateways</span>
        <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;gwlist&#39;</span><span class="p">:</span> <span class="n">gwlist_str</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Setup notifications</span>
        <span class="k">if</span> <span class="s1">&#39;notifications&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="n">overmaxcalllimit</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">][</span><span class="s1">&#39;overmaxcalllimit&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;overmaxcalllimit&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">endpointfailure</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">][</span><span class="s1">&#39;endpointfailure&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;endpointfailure&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;notifications&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">overmaxcalllimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">notif_type</span> <span class="o">=</span> <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">TYPE_OVERLIMIT</span><span class="o">.</span><span class="n">value</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">METHOD_EMAIL</span><span class="o">.</span><span class="n">value</span>
                <span class="n">notification</span> <span class="o">=</span> <span class="n">dSIPNotification</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">notif_type</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">overmaxcalllimit</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">endpointfailure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">notif_type</span> <span class="o">=</span> <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">TYPE_GWFAILURE</span><span class="o">.</span><span class="n">value</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">dSIPNotification</span><span class="o">.</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">METHOD_EMAIL</span><span class="o">.</span><span class="n">value</span>
                <span class="n">notification</span> <span class="o">=</span> <span class="n">dSIPNotification</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">notif_type</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">endpointfailure</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

        <span class="c1"># Enable CDR</span>
        <span class="k">if</span> <span class="s1">&#39;cdr&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
            <span class="n">cdr_email</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">][</span><span class="s1">&#39;cdr_email&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;cdr_email&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">cdr_send_interval</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">][</span><span class="s1">&#39;cdr_send_interval&#39;</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;cdr_send_interval&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cdr&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdr_email</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdr_send_interval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># create DB entry</span>
                <span class="n">cdrinfo</span> <span class="o">=</span> <span class="n">dSIPCDRInfo</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">cdr_email</span><span class="p">,</span> <span class="n">cdr_send_interval</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cdrinfo</span><span class="p">)</span>

                <span class="c1"># create crontab entry</span>
                <span class="n">cron_cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> cdr sendreport </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">settings</span><span class="o">.</span><span class="n">DSIP_PROJECT_DIR</span> <span class="o">+</span> <span class="s1">&#39;/gui/dsiprouter_cron.py&#39;</span><span class="p">),</span>
                                                         <span class="n">gwgroupid</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">addTaggedCronjob</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">cdr_send_interval</span><span class="p">,</span> <span class="n">cron_cmd</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Crontab entry could not be created&#39;</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Endpoint group created&#39;</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gwgroup_data</span><span class="p">)</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># TODO: standardize response payload (use data param)</span>
<span class="c1"># TODO: stop shadowing builtin functions! -&gt; type == builtin</span>
<span class="c1"># return value should be used in an http/flask context</span>
<div class="viewcode-block" id="generateCDRS"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.generateCDRS">[docs]</a><span class="k">def</span> <span class="nf">generateCDRS</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtfilter</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">cdrfilter</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate CDRs Report for a gwgroup</span>

<span class="sd">    :param gwgroupid:       gwgroup to generate cdr&#39;s for</span>
<span class="sd">    :type gwgroupid:        int|str</span>
<span class="sd">    :param type:            type of report (json|csv)</span>
<span class="sd">    :type type:             str</span>
<span class="sd">    :param email:           whether the report should be emailed</span>
<span class="sd">    :type email:            bool</span>
<span class="sd">    :param dtfilter:        time before which cdr&#39;s are not returned</span>
<span class="sd">    :type dtfilter:         datetime</span>
<span class="sd">    :param cdrfilter:       comma seperated cdr id&#39;s to include</span>
<span class="sd">    :type cdrfilter:        str</span>
<span class="sd">    :return:                returns a json response or file</span>
<span class="sd">    :rtype:                 flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="c1"># define here so we can cleanup in finally statement</span>
    <span class="n">csv_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">gwgroupid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">)</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">gwgroup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GatewayGroups</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gwgroup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gwgroupName</span> <span class="o">=</span> <span class="n">strFieldsToDict</span><span class="p">(</span><span class="n">gwgroup</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
            <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Endpont group doesn&#39;t exist&quot;</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdrfilter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;SELECT t1.cdr_id, t1.call_start_time, t1.duration AS call_duration, t1.calltype AS call_direction,</span>
<span class="sd">                          t2.id AS src_gwgroupid, substring_index(substring_index(t2.description, &#39;name:&#39;, -1), &#39;,&#39;, 1) AS src_gwgroupname,</span>
<span class="sd">                          t3.id AS dst_gwgroupid, substring_index(substring_index(t3.description, &#39;name:&#39;, -1), &#39;,&#39;, 1) AS dst_gwgroupname,</span>
<span class="sd">                          t1.src_username, t1.dst_username, t1.src_ip AS src_address, t1.dst_domain AS dst_address, t1.sip_call_id AS call_id</span>
<span class="sd">                FROM cdrs t1</span>
<span class="sd">                JOIN dr_gw_lists t2 ON (t1.src_gwgroupid = t2.id)</span>
<span class="sd">                JOIN dr_gw_lists t3 ON (t1.dst_gwgroupid = t3.id)</span>
<span class="sd">                WHERE (t2.id = &#39;{gwgroupid}&#39; OR t3.id = &#39;{gwgroupid}&#39;) AND t1.call_start_time &gt;= &#39;{dtfilter}&#39; AND t1.cdr_id IN ({cdrfilter})</span>
<span class="sd">                ORDER BY t1.call_start_time DESC;&quot;&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupid</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">dtfilter</span><span class="o">=</span><span class="n">dtfilter</span><span class="p">,</span> <span class="n">cdrfilter</span><span class="o">=</span><span class="n">cdrfilter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;SELECT t1.cdr_id, t1.call_start_time, t1.duration AS call_duration, t1.calltype AS call_direction,</span>
<span class="sd">                          t2.id AS src_gwgroupid, substring_index(substring_index(t2.description, &#39;name:&#39;, -1), &#39;,&#39;, 1) AS src_gwgroupname,</span>
<span class="sd">                          t3.id AS dst_gwgroupid, substring_index(substring_index(t3.description, &#39;name:&#39;, -1), &#39;,&#39;, 1) AS dst_gwgroupname,</span>
<span class="sd">                          t1.src_username, t1.dst_username, t1.src_ip AS src_address, t1.dst_domain AS dst_address, t1.sip_call_id AS call_id</span>
<span class="sd">                FROM cdrs t1</span>
<span class="sd">                JOIN dr_gw_lists t2 ON (t1.src_gwgroupid = t2.id)</span>
<span class="sd">                JOIN dr_gw_lists t3 ON (t1.dst_gwgroupid = t3.id)</span>
<span class="sd">                WHERE (t2.id = &#39;{gwgroupid}&#39; OR t3.id = &#39;{gwgroupid}&#39;) AND t1.call_start_time &gt;= &#39;{dtfilter}&#39;</span>
<span class="sd">                ORDER BY t1.call_start_time DESC;&quot;&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupid</span><span class="o">=</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="n">dtfilter</span><span class="o">=</span><span class="n">dtfilter</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cdrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;200&quot;</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;cdrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdrs</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;recordCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdrs</span><span class="p">)</span>

        <span class="c1"># Convert array of dicts to csv format</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupName</span><span class="p">,</span> <span class="n">now</span><span class="p">))</span>
            <span class="n">csv_file</span> <span class="o">=</span> <span class="s1">&#39;/tmp/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_fp</span><span class="p">:</span>
                <span class="n">dict_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csv_fp</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">cdrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">dict_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
                <span class="n">dict_writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">cdrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
                <span class="c1"># recipients required</span>
                <span class="n">cdr_info</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCDRInfo</span><span class="o">.</span><span class="n">gwgroupid</span> <span class="o">==</span> <span class="n">gwgroupid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cdr_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Setup the parameters to send the email</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;html_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;html&gt;CDR Report for </span><span class="si">{}</span><span class="s2">&lt;/html&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupName</span><span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;text_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CDR Report for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupName</span><span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CDR Report for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gwgroupName</span><span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;attachments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;attachments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;recipients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr_info</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">sendEmail</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
                    <span class="c1"># Remove CDR&#39;s from the payload thats being returned</span>
                    <span class="n">response_payload</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cdrs&#39;</span><span class="p">)</span>
                    <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span>
                    <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;email&#39;</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="getGatewayGroupCDRS"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.getGatewayGroupCDRS">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/cdrs/endpointgroups/&lt;int:gwgroupid&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">getGatewayGroupCDRS</span><span class="p">(</span><span class="n">gwgroupid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose</span>

<span class="sd">    Getting the cdrs for a gatewaygroup</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
        <span class="n">debugEndpoint</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">generateCDRS</span><span class="p">(</span><span class="n">gwgroupid</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">cdrfilter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span></div>


<span class="c1"># TODO: standardize response payload (use data param)</span>
<div class="viewcode-block" id="getGatewayCDRS"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.getGatewayCDRS">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/cdrs/endpoint/&lt;int:gwid&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">getGatewayCDRS</span><span class="p">(</span><span class="n">gwid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose</span>

<span class="sd">    Getting the cdrs for a gateway thats part of a gateway group</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select cdr_id, gwid, call_start_time, calltype as direction, dst_username as number,src_ip, dst_domain, duration,sip_call_id </span><span class="se">\</span>
<span class="s2">         from dr_gateways,cdrs where cdrs.src_ip = dr_gateways.address and gwid=</span><span class="si">{}</span><span class="s2"> order by call_start_time DESC;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">gwid</span><span class="p">)</span>

        <span class="n">cdrs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cdr</span> <span class="ow">in</span> <span class="n">cdrs</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cdr_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;gwid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;call_start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cdr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;calltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;src_ip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dst_domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sip_call_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;cdrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
            <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;recordCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
            <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;200&quot;</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="createBackup"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.createBackup">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/backupandrestore/backup&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">createBackup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a backup of the database</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># define here so we can cleanup in finally statement</span>
    <span class="n">backup_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">backup_name</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.sql&quot;</span>
        <span class="n">backup_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BACKUP_FOLDER</span><span class="p">,</span> <span class="n">backup_name</span><span class="p">)</span>
        <span class="c1"># need to decrypt password</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_PASS</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">kampass</span> <span class="o">=</span> <span class="n">AES_CTR</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_PASS</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kampass</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_PASS</span>

        <span class="n">dumpcmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/bin/mysqldump&#39;</span><span class="p">,</span> <span class="s1">&#39;--single-transaction&#39;</span><span class="p">,</span> <span class="s1">&#39;--opt&#39;</span><span class="p">,</span> <span class="s1">&#39;--routines&#39;</span><span class="p">,</span> <span class="s1">&#39;--triggers&#39;</span><span class="p">,</span> <span class="s1">&#39;--hex-blob&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_HOST</span><span class="p">,</span> <span class="s1">&#39;-u&#39;</span><span class="p">,</span>
                   <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_USER</span><span class="p">,</span> <span class="s1">&#39;-p</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kampass</span><span class="p">),</span> <span class="s1">&#39;-B&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_NAME</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">dumpcmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;&#39;&#39;DEFINER=[`&quot;\&#39;][a-zA-Z0-9_%]*[`&quot;\&#39;]@[`&quot;\&#39;][a-zA-Z0-9_%]*[`&quot;\&#39;]&#39;&#39;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dump</span><span class="p">,</span>
                          <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;ENGINE=MyISAM&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;ENGINE=InnoDB&#39;</span><span class="p">,</span> <span class="n">dump</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dump</span><span class="p">)</span>

        <span class="c1"># lines = &quot;It wrote the backup&quot;</span>
        <span class="c1"># attachment = &quot;attachment; filename=dsiprouter_{}_{}.sql&quot;.format(settings.VERSION,backupDateTime)</span>
        <span class="c1"># headers={&quot;Content-disposition&quot;:attachment}</span>
        <span class="c1"># return Response(lines, mimetype=&quot;text/plain&quot;,headers=headers)</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="n">backup_name</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">backup_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">backup_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="restoreBackup"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.restoreBackup">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/backupandrestore/restore&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">restoreBackup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restore backup of the database</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>

        <span class="n">KAM_DB_USER</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_USER</span>
        <span class="n">KAM_DB_PASS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_PASS</span>

        <span class="k">if</span> <span class="s1">&#39;db_username&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">KAM_DB_USER</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_username&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">KAM_DB_USER</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">KAM_DB_PASS</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_password&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;No file was sent&quot;</span><span class="p">)</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;No file name was sent&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">ALLOWED_EXTENSIONS</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sql&#39;</span><span class="p">}):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">restore_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BACKUP_FOLDER</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">restore_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Improper file upload&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">KAM_DB_PASS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">restorecmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/bin/mysql&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_HOST</span><span class="p">,</span> <span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="n">KAM_DB_USER</span><span class="p">,</span> <span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_NAME</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">restorecmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/bin/mysql&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_HOST</span><span class="p">,</span> <span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="n">KAM_DB_USER</span><span class="p">,</span> <span class="s1">&#39;-p</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">KAM_DB_PASS</span><span class="p">),</span>
                          <span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">KAM_DB_NAME</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">restore_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">restorecmd</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The restore was successful&quot;</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">response_payload</span><span class="p">,</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">response_payload</span><span class="p">)</span></div>


<div class="viewcode-block" id="generatePassword"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.generatePassword">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/sys/generatepassword&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">generatePassword</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a random password</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEF_PASSWORD_LEN</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">urandomChars</span><span class="p">(</span><span class="n">DEF_PASSWORD_LEN</span><span class="p">))</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Succesfully generated password&#39;</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">response_payload</span><span class="p">)</span></div>


<span class="c1"># TODO:  The response coming back from Kamailio Command Line</span>
<span class="c1">#        is not in proper JSON format.  The field and Attributes</span>
<span class="c1">#        are missing double quotes.  So, we need to fix the JSON</span>
<span class="c1">#        payload and loop thru the result vs doing a find.</span>
<span class="c1">#        Or if we do a JSONRPC call instead we will get proper JSON</span>
<div class="viewcode-block" id="getOptionMessageStatus"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.getOptionMessageStatus">[docs]</a><span class="k">def</span> <span class="nf">getOptionMessageStatus</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if Domain is receiving replies from OPTION Messages</span>
<span class="sd">    :param domain:  domain to check</span>
<span class="sd">    :type domain:   str</span>
<span class="sd">    :return:        whether domain handled OPTION message correctly</span>
<span class="sd">    :rtype:         bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;kamcmd&#39;</span><span class="p">,</span> <span class="s1">&#39;dispatcher.list&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">response_formatted</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="n">found_domain</span> <span class="o">=</span> <span class="n">response_formatted</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">found_domain</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">found_inactive</span> <span class="o">=</span> <span class="n">response_formatted</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;FLAGS: IP&quot;</span><span class="p">,</span> <span class="n">found_domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found_inactive</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="testConnectivity"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.testConnectivity">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/domains/msteams/test/&lt;string:domain&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">testConnectivity</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hostname_check&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;tls_check&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;option_check&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="n">external_ip_addr</span> <span class="o">=</span> <span class="n">getExternalIP</span><span class="p">()</span>
        <span class="n">internal_ip_address</span> <span class="o">=</span> <span class="n">hostToIP</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

        <span class="c1"># Check the external ip matchs the ip set on the server</span>
        <span class="k">if</span> <span class="n">external_ip_addr</span> <span class="o">==</span> <span class="n">internal_ip_address</span><span class="p">:</span>
            <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;hostname_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Try again, but use Google DNS resolver if the check fails with local DNS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Does the IP address of this server resolve to the domain</span>
            <span class="kn">import</span> <span class="nn">dns.resolver</span>

            <span class="c1"># Get the IP address of the domain from Google  DNS</span>
            <span class="n">resolver</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">Resolver</span><span class="p">()</span>
            <span class="n">resolver</span><span class="o">.</span><span class="n">nameservers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;8.8.8.8&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">answers</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">:</span>
                    <span class="c1"># If the External IP and IP from DNS match then it passes the check</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">to_text</span><span class="p">()</span> <span class="o">==</span> <span class="n">external_ip_addr</span><span class="p">:</span>
                        <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;hostname_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Check if Domain is the root of the CN</span>
        <span class="c1"># GoDaddy Certs Don&#39;t work with Microsoft Direct routing</span>
        <span class="n">certInfo</span> <span class="o">=</span> <span class="n">isCertValid</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">external_ip_addr</span><span class="p">,</span> <span class="mi">5061</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">certInfo</span><span class="p">:</span>
            <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;tls_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">certInfo</span>

        <span class="c1"># check if domain can process OPTIONS messages</span>
        <span class="k">if</span> <span class="n">getOptionMessageStatus</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
            <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;option_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tests ran without error&#39;</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span></div>


<span class="c1"># TODO: implement GET for single domain</span>
<div class="viewcode-block" id="getCertificates"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.getCertificates">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/certificates&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/certificates/&lt;string:domain&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">getCertificates</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># if domain is not None:</span>
        <span class="c1">#     domain_configs = getCustomTLSConfigs(domain)</span>
        <span class="c1"># else:</span>
        <span class="c1">#domain_configs = getCustomTLSConfigs()</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">certificates</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">certificates</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">certificate</span> <span class="ow">in</span> <span class="n">certificates</span><span class="p">:</span>
            <span class="c1"># append summary of endpoint group data</span>
            <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">certificate</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="n">certificate</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">certificate</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="s1">&#39;assigned_domains&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
            <span class="p">})</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Certificates found&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">certificates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;No Certificates&#39;</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="createCertificate"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.createCertificate">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/certificates&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">createCertificate</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create TLS cert for a domain</span>

<span class="sd">    ===============</span>
<span class="sd">    Request Payload</span>
<span class="sd">    ===============</span>

<span class="sd">    .. code-block:: json</span>

<span class="sd">    {</span>
<span class="sd">        domain: &lt;string&gt;,</span>
<span class="sd">        ip: &lt;int&gt;,</span>
<span class="sd">        port: &lt;int&gt;</span>
<span class="sd">        server_name_mode: &lt;int&gt;</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="n">CERT_TYPE_GENERATED</span> <span class="o">=</span> <span class="s2">&quot;generated&quot;</span>
    <span class="n">CERT_TYPE_UPLOADED</span> <span class="o">=</span> <span class="s2">&quot;uploaded&quot;</span>

    <span class="c1"># defaults.. keep data returned separate from returned metadata</span>
    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="c1"># Check parameters and raise exception if missing required parameters</span>
    <span class="n">requiredParameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">request_payload</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">requiredParameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_payload</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Request Argument &#39;</span><span class="si">{}</span><span class="s2">&#39; is Required&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameter</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">request_payload</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">request_payload</span><span class="p">[</span><span class="n">parameter</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Value for Request Argument &#39;</span><span class="si">{}</span><span class="s2">&#39; is Not Valid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameter</span><span class="p">))</span>

        <span class="c1"># Process Request</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ip&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_IP_ADDR</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="mi">5061</span>
        <span class="n">server_name_mode</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;server_name_mode&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="s1">&#39;server_name_mode&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="n">KAM_TLS_SNI_ALL</span>
        <span class="n">key</span> <span class="o">=</span>  <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;key&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">replace_default_cert</span> <span class="o">=</span>  <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;replace_default_cert&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;replace_default_cert&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;cert&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;cert&#39;</span> <span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request_payload</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;email&#39;</span><span class="ow">in</span> <span class="n">request_payload</span> <span class="k">else</span> <span class="s2">&quot;admin@&quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOMAIN</span>

        <span class="c1"># Request Certificate via Let&#39;s Encrypt</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cert</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">CERT_TYPE_GENERATED</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="c1"># Use the LetsEncrypt Staging Server</span>

                    <span class="n">key</span><span class="p">,</span><span class="n">cert</span><span class="o">=</span><span class="n">generateCertificate</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="n">email</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">replace_default_cert</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Use the LetsEncrypt Prod Server</span>
                    <span class="n">key</span><span class="p">,</span><span class="n">cert</span><span class="o">=</span><span class="n">generateCertificate</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="n">email</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">replace_default_cert</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Issue with validating ownership of the domain.  Please add a DNS record for this domain and try again&quot;</span><span class="p">)</span>


        <span class="c1"># Convert Certificate and key to base64 so that they can be stored in the database</span>
        <span class="n">cert_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">cert</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="n">key_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>


        <span class="c1">#Check if the domain exists.  If so, update versus writing new</span>
        <span class="n">certificate</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">certificate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#Update</span>
            <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;email&#39;</span><span class="p">:</span><span class="n">email</span><span class="p">,</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="nb">type</span><span class="p">,</span><span class="s1">&#39;cert&#39;</span><span class="p">:</span><span class="n">cert_base64</span><span class="p">,</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="n">key_base64</span><span class="p">})</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># Update the Kamailio TLS Configuration</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">updateCustomTLSConfig</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">server_name_mode</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to add Certificate to Kamailio&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Store a new Certificate in dSIPCertificate Table</span>
            <span class="n">certificate</span> <span class="o">=</span> <span class="n">dSIPCertificates</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">cert_base64</span><span class="p">,</span> <span class="n">key_base64</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># Write the Kamailio TLS Configuration</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">addCustomTLSConfig</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">server_name_mode</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to add Certificate to Kamailio&#39;</span><span class="p">)</span>


        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Certificate creation succeeded&quot;</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">certificate</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="deleteCertificates"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.deleteCertificates">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/certificates/&lt;string:domain&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">deleteCertificates</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="c1"># if domain is not None:</span>
        <span class="c1">#     domain_configs = getCustomTLSConfigs(domain)</span>
        <span class="c1"># else:</span>
        <span class="c1">#domain_configs = getCustomTLSConfigs()</span>

        <span class="n">Certificates</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dSIPCertificates</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span><span class="p">)</span>
        <span class="n">Certificates</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Remove the certificate from the file system</span>
        <span class="n">deleteCertificate</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

        <span class="c1"># Remove from Kamailio TLS</span>
        <span class="n">deleteCustomTLSConfig</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Certificate Deleted&#39;</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="uploadCertificates"><a class="viewcode-back" href="../../../dev/modules.html#modules.api.api_routes.uploadCertificates">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/v1/certificates/upload/&lt;string:domain&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@api_security</span>
<span class="k">def</span> <span class="nf">uploadCertificates</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>

    <span class="n">response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;kamreload&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>

            <span class="n">debugEndpoint</span><span class="p">()</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLoader</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">getRequestData</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;domain&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;replace_default_cert&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">replace_default_cert</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;replace_default_cert&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">replace_default_cert</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">ip</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">EXTERNAL_IP_ADDR</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">5061</span>
        <span class="n">server_name_mode</span> <span class="o">=</span> <span class="n">KAM_TLS_SNI_ALL</span>
        <span class="n">email</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">cert_dir</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DSIP_CERTS_DIR</span>
        <span class="k">if</span> <span class="n">replace_default_cert</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="c1"># Replacing the default cert</span>
            <span class="n">cert_domain_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Adding a another domain cert</span>
            <span class="n">cert_domain_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_dir</span><span class="p">,</span><span class="n">domain</span><span class="p">)</span>

        <span class="c1"># Create a directory for the domain</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_domain_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cert_domain_dir</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;certandkey&quot;</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">ALLOWED_EXTENSIONS</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;crt&#39;</span><span class="p">,</span><span class="s1">&#39;key&#39;</span><span class="p">,</span><span class="s1">&#39;cert&#39;</span><span class="p">,</span><span class="s1">&#39;pem&#39;</span><span class="p">}):</span>
              <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;Only files ending in .cert, .crt, .key, .pem are allowed&quot;</span><span class="p">)</span>
          <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;crt|cert&#39;</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
              <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;dsiprouter.crt&quot;</span>
              <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cert_domain_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
              <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
              <span class="n">cert</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()))</span>
          <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;key|pem&#39;</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
              <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;dsiprouter.key&quot;</span>
              <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cert_domain_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
              <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
              <span class="n">key</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()))</span>


        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cert</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">http_exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s2">&quot;A certificate and key file must be provided&quot;</span><span class="p">)</span>

        <span class="n">key_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/dsiprouter.key&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_domain_dir</span><span class="p">)</span>
        <span class="n">cert_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/dsiprouter.crt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_domain_dir</span><span class="p">)</span>

        <span class="c1"># Change owner to root:kamailio so that Kamailio can load the configurations</span>
        <span class="n">change_owner</span><span class="p">(</span><span class="n">cert_domain_dir</span><span class="p">,</span><span class="s2">&quot;root&quot;</span><span class="p">,</span><span class="s2">&quot;kamailio&quot;</span><span class="p">)</span>
        <span class="n">change_owner</span><span class="p">(</span><span class="n">key_file</span><span class="p">,</span><span class="s2">&quot;root&quot;</span><span class="p">,</span><span class="s2">&quot;kamailio&quot;</span><span class="p">)</span>
        <span class="n">change_owner</span><span class="p">(</span><span class="n">cert_file</span><span class="p">,</span><span class="s2">&quot;root&quot;</span><span class="p">,</span><span class="s2">&quot;kamailio&quot;</span><span class="p">)</span>

        <span class="c1"># Convert Certificate and key to base64 so that they can be stored in the database</span>
        <span class="n">cert_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">key_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="c1"># Store Certificate in dSIPCertificate Table</span>
        <span class="n">certificate</span> <span class="o">=</span> <span class="n">dSIPCertificates</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="s2">&quot;uploaded&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cert_base64</span><span class="p">,</span> <span class="n">key_base64</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">replace_default_cert</span><span class="p">:</span>
            <span class="c1"># Write the Kamailio TLS Configuration if it&#39;s not the default</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">addCustomTLSConfig</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">server_name_mode</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to add Certificate to Kamailio&#39;</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Certificate and Key were uploaded&quot;</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">certificate</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="nb">globals</span><span class="o">.</span><span class="n">reload_required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response_payload</span><span class="p">[</span><span class="s1">&#39;kamreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_payload</span><span class="p">),</span> <span class="n">StatusCodes</span><span class="o">.</span><span class="n">HTTP_OK</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">showApiError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright dOpenSource

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>